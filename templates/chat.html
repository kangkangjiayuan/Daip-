<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>DaiPÊô∫ËÉΩËÅäÂ§©ÂÆ§</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
        }
        
        body {
            min-height: 100vh;
            background: #f5f7fa;
            display: flex;
            flex-direction: column;
        }
        
        .chat-container {
            display: flex;
            height: 100vh;
            width: 100%;
            overflow: hidden;
        }
        
        /* ‰æßËæπÊ†è */
        .sidebar {
            width: 280px;
            background: white;
            box-shadow: 2px 0 10px rgba(0,0,0,0.05);
            display: flex;
            flex-direction: column;
            transition: transform 0.3s ease;
            position: relative;
        }
        
        .sidebar-header {
            padding: 20px;
            background: linear-gradient(45deg, #FFB6C1, #87CEEB);
            color: white;
        }
        
        .sidebar-header h2 {
            font-size: 1.5rem;
            font-weight: 600;
        }
        
        .sidebar-header p {
            font-size: 12px;
            opacity: 0.8;
            margin-top: 5px;
        }
        
        .online-users {
            flex: 1;
            overflow-y: auto;
            padding: 20px;
            background: linear-gradient(180deg, #FFE4E1, #E0F6FF);
        }
        
        .section-title {
            font-size: 12px;
            font-weight: 600;
            color: #666;
            text-transform: uppercase;
            letter-spacing: 1px;
            margin-bottom: 15px;
        }
        
        .user-list {
            list-style: none;
        }
        
        .user-item {
            display: flex;
            align-items: center;
            padding: 10px;
            border-radius: 10px;
            margin-bottom: 5px;
            transition: background 0.2s ease;
            cursor: pointer;
        }
        
        .user-item:hover {
            background: #f5f7fa;
        }
        
        .user-avatar {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background: linear-gradient(45deg, #FFB6C1, #87CEEB);
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: 600;
            margin-right: 12px;
            box-shadow: 0 2px 8px rgba(255,182,193,0.3);
        }
        
        .user-info {
            flex: 1;
        }
        
        .user-name {
            font-weight: 500;
            color: #333;
        }
        
        .user-status {
            font-size: 11px;
            color: #4caf50;
            margin-top: 2px;
        }
        
        /* ËÅäÂ§©Âå∫Âüü */
        .chat-area {
            flex: 1;
            display: flex;
            flex-direction: column;
            background: #f5f7fa;
            position: relative;
        }
        
        .chat-header {
            padding: 20px;
            background: linear-gradient(45deg, #FFE4E1, #E0F6FF);
            box-shadow: 0 2px 10px rgba(255,182,193,0.1);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .chat-header h2 {
            font-size: 1.2rem;
            color: #333;
        }
        
        .logout-btn {
            padding: 8px 16px;
            background: #ff4757;
            color: white;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-size: 14px;
            transition: background 0.2s ease;
        }
        
        .logout-btn:hover {
            background: #ff3742;
        }
        
        .history-btn {
            padding: 8px 16px;
            background: linear-gradient(45deg, #FFB6C1, #87CEEB);
            color: white;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-size: 14px;
            transition: background 0.2s ease;
            margin-left: 10px;
        }
        
        .history-btn:hover {
            background: linear-gradient(45deg, #FF69B4, #4682B4);
        }
        
        /* ÂéÜÂè≤ËÆ∞ÂΩïÊ®°ÊÄÅÊ°Ü */
        .history-modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0,0,0,0.5);
            backdrop-filter: blur(5px);
        }
        
        .history-modal.active {
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        .history-content {
            background: white;
            padding: 0;
            border-radius: 12px;
            width: 90%;
            max-width: 800px;
            height: 80%;
            max-height: 600px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.3);
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }
        
        .history-header {
            padding: 20px;
            background: linear-gradient(45deg, #FFE4E1, #E0F6FF);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .history-header h3 {
            margin: 0;
            color: #333;
            font-size: 1.2rem;
        }
        
        .close-history {
            background: none;
            border: none;
            font-size: 24px;
            cursor: pointer;
            color: #666;
            padding: 5px;
            border-radius: 50%;
            transition: background 0.2s ease;
        }
        
        .close-history:hover {
            background: rgba(255,255,255,0.3);
        }
        
        .history-body {
            flex: 1;
            padding: 20px;
            overflow-y: auto;
            display: flex;
            flex-direction: column;
            gap: 10px;
        }
        
        .history-message {
            padding: 12px 16px;
            border-radius: 12px;
            max-width: 80%;
            word-wrap: break-word;
            line-height: 1.4;
        }
        
        .history-message.own {
            background: linear-gradient(45deg, #FFB6C1, #87CEEB);
            color: white;
            align-self: flex-end;
        }
        
        .history-message.other {
            background: #f5f7fa;
            color: #333;
            align-self: flex-start;
        }
        
        .history-message.ai {
            background: #e8f5e9;
            color: #2e7d32;
            font-style: italic;
            align-self: center;
        }
        
        .history-time {
            font-size: 11px;
            color: #999;
            margin-top: 4px;
            text-align: center;
        }
        
        .no-history {
            text-align: center;
            color: #999;
            padding: 40px;
            font-style: italic;
        }
        
        .messages-container {
            flex: 1;
            overflow-y: auto;
            padding: 20px;
            display: flex;
            flex-direction: column;
            gap: 15px;
        }
        
        .message {
            max-width: 70%;
            animation: fadeIn 0.3s ease;
        }
        
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        .message.own {
            align-self: flex-end;
        }
        
        .message.other {
            align-self: flex-start;
        }
        
        .message.ai {
            align-self: center;
            max-width: 90%;
        }
        
        .message-header {
            display: flex;
            align-items: center;
            margin-bottom: 5px;
        }
        
        .message-avatar {
            width: 30px;
            height: 30px;
            border-radius: 50%;
            background: linear-gradient(45deg, #FFB6C1, #87CEEB);
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 12px;
            font-weight: 600;
            margin-right: 8px;
            box-shadow: 0 2px 8px rgba(255,182,193,0.3);
        }
        
        .message-username {
            font-size: 12px;
            font-weight: 600;
            color: #666;
        }
        
        .message-content {
            background: linear-gradient(45deg, #FFE4E1, #E0F6FF);
            padding: 12px 16px;
            border-radius: 18px;
            word-wrap: break-word;
            line-height: 1.4;
            box-shadow: 0 2px 8px rgba(255,182,193,0.2);
        }
        
        .message.own .message-content {
            background: linear-gradient(45deg, #FFB6C1, #87CEEB);
            color: white;
        }
        
        .message.ai .message-content {
            background: #e8f5e9;
            color: #2e7d32;
            font-style: italic;
        }
        
        .message.at .message-content {
            background: #fff3e0;
            border-left: 4px solid #ff9800;
        }
        
        .message.movie .message-content {
            background: #e3f2fd;
        }
        
        .movie-player {
            margin-top: 10px;
            border-radius: 10px;
            overflow: hidden;
            border: 2px solid #ddd;
            box-shadow: 0 4px 15px rgba(0,0,0,0.1);
            transition: all 0.3s ease;
        }
        
        .movie-player:hover {
            box-shadow: 0 6px 20px rgba(0,0,0,0.15);
        }
        
        .movie-player iframe {
            width: 100%;
            max-width: 100%;
            height: 360px;
            border: none;
            border-radius: 8px;
        }
        
        @media (max-width: 768px) {
            .movie-player iframe {
                width: 100%;
                height: 300px;
            }
        }
        
        /* ËæìÂÖ•Âå∫Âüü */
        .input-area {
            background: linear-gradient(45deg, #FFE4E1, #E0F6FF);
            padding: 20px;
            box-shadow: 0 -2px 10px rgba(255,182,193,0.1);
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .emoji-btn {
            width: 40px;
            height: 40px;
            border: none;
            background: linear-gradient(45deg, #FFE4E1, #E0F6FF);
            font-size: 24px;
            cursor: pointer;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s ease;
            z-index: 10;
            box-shadow: 0 2px 8px rgba(255,182,193,0.3);
        }
        
        .emoji-btn:hover {
            background: linear-gradient(45deg, #FFB6C1, #87CEEB);
            transform: scale(1.05);
            box-shadow: 0 4px 12px rgba(255,182,193,0.5);
        }
        
        /* AIÊåâÈíÆ */
        .ai-btn {
            width: 40px;
            height: 40px;
            border: none;
            background: linear-gradient(45deg, #FFB6C1, #87CEEB);
            color: white;
            border-radius: 50%;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 20px;
            transition: all 0.2s ease;
            box-shadow: 0 2px 8px rgba(255,182,193,0.4);
        }
        
        .ai-btn:hover {
            background: linear-gradient(45deg, #FF69B4, #4682B4);
            transform: scale(1.05);
            box-shadow: 0 4px 12px rgba(255,182,193,0.6);
        }
        
        .ai-btn:active {
            transform: scale(0.95);
        }
        
        /* Èü≥‰πêÊåâÈíÆ */
        .music-btn {
            width: 40px;
            height: 40px;
            border: none;
            background: linear-gradient(45deg, #FF6B9D, #C44569);
            color: white;
            border-radius: 50%;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 20px;
            transition: all 0.2s ease;
            box-shadow: 0 2px 8px rgba(255,107,157,0.4);
        }
        
        .music-btn:hover {
            background: linear-gradient(45deg, #FF5252, #E91E63);
            transform: scale(1.05);
            box-shadow: 0 4px 12px rgba(255,107,157,0.6);
        }
        
        .music-btn:active {
            transform: scale(0.95);
        }
        
        /* Â§©Ê∞îÊåâÈíÆ */
        .weather-btn {
            width: 40px;
            height: 40px;
            border: none;
            background: linear-gradient(45deg, #74B9FF, #0984E3);
            color: white;
            border-radius: 50%;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 20px;
            transition: all 0.2s ease;
            box-shadow: 0 2px 8px rgba(116,185,255,0.4);
        }
        
        .weather-btn:hover {
            background: linear-gradient(45deg, #00CEC9, #00A8E8);
            transform: scale(1.05);
            box-shadow: 0 4px 12px rgba(116,185,255,0.6);
        }
        
        .weather-btn:active {
            transform: scale(0.95);
        }
        
        /* Êñ∞ÈóªÊåâÈíÆ */
        .news-btn {
            width: 40px;
            height: 40px;
            border: none;
            background: linear-gradient(45deg, #6C5CE7, #A29BFE);
            color: white;
            border-radius: 50%;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 20px;
            transition: all 0.2s ease;
            box-shadow: 0 2px 8px rgba(108, 92, 231, 0.4);
        }
        
        .news-btn:hover {
            background: linear-gradient(45deg, #A29BFE, #6C5CE7);
            transform: scale(1.05);
            box-shadow: 0 4px 12px rgba(108, 92, 231, 0.6);
        }
        
        .news-btn:active {
            transform: scale(0.95);
        }
        
        /* Ë°®ÊÉÖÂåÖÈù¢Êùø */
        .emoji-panel {
            position: absolute;
            bottom: 80px;
            left: 20px;
            width: 280px;
            max-height: 200px;
            background: white;
            border-radius: 12px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.15);
            padding: 15px;
            overflow-y: auto;
            display: none;
            z-index: 100;
        }
        
        .emoji-panel.active {
            display: grid;
            grid-template-columns: repeat(8, 1fr);
            gap: 5px;
        }
        
        /* ÂºπÂá∫Èü≥‰πêÂç°ÁâáÊ†∑Âºè */
        .popup-music-card {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: linear-gradient(135deg, #FF6B9D, #C44569);
            border-radius: 20px;
            padding: 25px;
            color: white;
            box-shadow: 0 20px 40px rgba(255,107,157,0.5);
            z-index: 1000;
            min-width: 400px;
            max-width: 500px;
            backdrop-filter: blur(20px);
            border: 1px solid rgba(255,255,255,0.2);
            display: none;
            animation: popup-fadeIn 0.3s ease;
        }
        
        .popup-music-card.show {
            display: block;
        }
        
        @keyframes popup-fadeIn {
            0% {
                opacity: 0;
                transform: translate(-50%, -50%) scale(0.8);
            }
            100% {
                opacity: 1;
                transform: translate(-50%, -50%) scale(1);
            }
        }
        
        .popup-music-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }
        
        .popup-music-title {
            font-size: 20px;
            font-weight: bold;
            margin-bottom: 5px;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }
        
        .popup-music-artist {
            font-size: 14px;
            opacity: 0.9;
        }
        
        .close-popup-btn {
            background: rgba(255,255,255,0.2);
            border: none;
            border-radius: 50%;
            width: 32px;
            height: 32px;
            color: white;
            cursor: pointer;
            font-size: 16px;
            transition: all 0.2s ease;
        }
        
        .close-popup-btn:hover {
            background: rgba(255,255,255,0.3);
            transform: scale(1.1);
        }
        
        .popup-music-info {
            margin-bottom: 20px;
        }
        
        .music-album-art {
            width: 200px;
            height: 200px;
            background: rgba(255,255,255,0.1);
            border-radius: 50%;
            margin: 0 auto 30px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 80px;
            box-shadow: 0 0 30px rgba(255, 215, 0, 0.3);
            animation: vinyl-rotate 3s linear infinite;
        }
        
        @keyframes vinyl-rotate {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        .music-progress {
            margin: 20px 0;
        }
        
        .progress-bar {
            width: 100%;
            height: 6px;
            background: rgba(255,255,255,0.3);
            border-radius: 3px;
            overflow: hidden;
            cursor: pointer;
            margin-bottom: 8px;
        }
        
        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, #FFD700, #FFA500);
            border-radius: 3px;
            width: 0%;
            transition: width 0.1s ease;
        }
        
        .progress-time {
            display: flex;
            justify-content: space-between;
            font-size: 12px;
            opacity: 0.8;
        }
        
        .popup-music-controls {
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 15px;
            margin: 20px 0;
        }
        
        .popup-control-btn {
            background: linear-gradient(45deg, rgba(255,255,255,0.2), rgba(255,255,255,0.1));
            border: 1px solid rgba(255,255,255,0.3);
            border-radius: 50%;
            width: 50px;
            height: 50px;
            color: white;
            cursor: pointer;
            font-size: 18px;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            box-shadow: 0 4px 15px rgba(0,0,0,0.2);
        }
        
        .popup-control-btn:hover {
            background: linear-gradient(45deg, rgba(255,255,255,0.3), rgba(255,255,255,0.2));
            transform: scale(1.15);
            box-shadow: 0 6px 20px rgba(0,0,0,0.3);
        }
        
        .popup-play-btn {
            width: 60px;
            height: 60px;
            font-size: 24px;
            background: linear-gradient(45deg, #FFD700, #FFA500);
        }
        
        .random-btn {
            background: linear-gradient(45deg, #8A2BE2, #9370DB, #FF69B4, #FF1493);
            background-size: 400% 400%;
            animation: gradientShift 3s ease infinite;
            box-shadow: 0 0 20px rgba(138, 43, 226, 0.6);
        }
        
        .random-btn:hover {
            background: linear-gradient(45deg, #9370DB, #8A2BE2, #FF1493, #FF69B4);
            background-size: 400% 400%;
            transform: scale(1.2);
            box-shadow: 0 0 30px rgba(138, 43, 226, 0.9);
        }
        
        @keyframes gradientShift {
            0% { background-position: 0% 50%; }
            50% { background-position: 100% 50%; }
            100% { background-position: 0% 50%; }
        }
        
        .popup-qqmusic-btn {
            background: linear-gradient(45deg, #00D4FF, #0099CC);
            border-radius: 25px;
            width: auto;
            height: 40px;
            padding: 0 20px;
            font-size: 14px;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
        }
        
        .popup-qqmusic-btn:hover {
            background: linear-gradient(45deg, #00B8E6, #0088BB);
        }
        
        /* ÂºπÂá∫Êñ∞ÈóªÂç°ÁâáÊ†∑Âºè */
        .popup-news-card {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: linear-gradient(135deg, #6C5CE7, #A29BFE);
            border-radius: 20px;
            padding: 25px;
            color: white;
            box-shadow: 0 20px 40px rgba(108, 92, 231, 0.5);
            z-index: 1000;
            min-width: 500px;
            max-width: 700px;
            max-height: 80vh;
            backdrop-filter: blur(20px);
            border: 1px solid rgba(255,255,255,0.2);
            display: none;
            animation: popup-fadeIn 0.3s ease;
            overflow: hidden;
        }
        
        .popup-news-card.show {
            display: block;
        }
        
        .news-list {
            max-height: 60vh;
            overflow-y: auto;
            margin: 20px 0;
            padding-right: 10px;
        }
        
        .news-item {
            background: rgba(255, 255, 255, 0.1);
            border-radius: 12px;
            padding: 15px;
            margin-bottom: 15px;
            cursor: pointer;
            transition: all 0.3s ease;
            border: 1px solid rgba(255, 255, 255, 0.2);
        }
        
        .news-item:hover {
            background: rgba(255, 255, 255, 0.2);
            transform: translateY(-2px);
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.2);
        }
        
        .news-item.active {
            background: rgba(255, 255, 255, 0.3);
            transform: translateY(-2px);
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.3);
        }
        
        .news-title {
            font-size: 16px;
            font-weight: bold;
            margin-bottom: 8px;
            line-height: 1.4;
        }
        
        .news-summary {
            font-size: 14px;
            opacity: 0.9;
            margin-bottom: 10px;
            line-height: 1.5;
        }
        
        .news-meta {
            display: flex;
            justify-content: space-between;
            align-items: center;
            font-size: 12px;
            opacity: 0.8;
        }
        
        .news-category {
            background: rgba(255, 255, 255, 0.2);
            padding: 4px 8px;
            border-radius: 12px;
            font-size: 11px;
        }
        
        .news-read-time {
            background: rgba(255, 255, 255, 0.2);
            padding: 4px 8px;
            border-radius: 12px;
            font-size: 11px;
        }
        
        .news-image {
            width: 100%;
            height: 150px;
            background: rgba(255, 255, 255, 0.2);
            border-radius: 8px;
            margin-bottom: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 48px;
        }
        
        .news-controls {
            display: flex;
            justify-content: center;
            gap: 15px;
            margin-top: 20px;
        }
        
        .news-control-btn {
            background: rgba(255, 255, 255, 0.2);
            border: none;
            border-radius: 25px;
            color: white;
            padding: 10px 20px;
            cursor: pointer;
            font-size: 14px;
            transition: all 0.2s ease;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .news-control-btn:hover {
            background: rgba(255, 255, 255, 0.3);
            transform: scale(1.05);
        }
        
        .news-timer {
            background: rgba(255, 255, 255, 0.2);
            padding: 8px 16px;
            border-radius: 20px;
            font-size: 14px;
            font-weight: bold;
        }
        
        .overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.5);
            z-index: 999;
            display: none;
        }
        
        .overlay.show {
            display: block;
        }
        
        .emoji-item {
            width: 30px;
            height: 30px;
            font-size: 20px;
            display: flex;
            align-items: center;
            justify-content: center;
            border: none;
            background: none;
            cursor: pointer;
            border-radius: 6px;
            transition: background 0.2s ease;
        }
        
        .emoji-item:hover {
            background: #f5f7fa;
        }
        
        .message-input {
            flex: 1;
            padding: 12px 16px;
            border: 2px solid #FFB6C1;
            border-radius: 25px;
            font-size: 16px;
            outline: none;
            transition: all 0.2s ease;
            resize: none;
            max-height: 100px;
            min-height: 45px;
            background: rgba(255,228,225,0.3);
            overflow-y: auto;
            /* ÈöêËóèÊªöÂä®Êù°‰ΩÜ‰øùÊåÅÊªöÂä®ÂäüËÉΩ */
            scrollbar-width: none; /* Firefox ÈöêËóèÊªöÂä®Êù° */
            -ms-overflow-style: none; /* IE Âíå Edge ÈöêËóèÊªöÂä®Êù° */
        }
        
        /* WebKit ÊµèËßàÂô®ÈöêËóèÊªöÂä®Êù° */
        .message-input::-webkit-scrollbar {
            display: none;
        }
        
        .message-input:focus {
            border-color: #87CEEB;
            box-shadow: 0 0 0 4px rgba(255,182,193,0.2);
            background: rgba(255,255,255,0.8);
        }
        
        .send-btn {
            width: 45px;
            height: 45px;
            border: none;
            background: linear-gradient(45deg, #FFB6C1, #87CEEB);
            color: white;
            border-radius: 50%;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s ease;
            box-shadow: 0 2px 8px rgba(255,182,193,0.4);
        }
        
        .send-btn:hover {
            transform: scale(1.1);
            box-shadow: 0 4px 12px rgba(255,182,193,0.6);
        }
        
        .send-btn:active {
            transform: scale(0.95);
        }
        
        /* ÁßªÂä®Á´ØÂìçÂ∫îÂºè */
        @media (max-width: 768px) {
            .sidebar {
                position: absolute;
                left: 0;
                top: 0;
                height: 100vh;
                transform: translateX(-100%);
                z-index: 1000;
            }
            
            .sidebar.active {
                transform: translateX(0);
            }
            
            .chat-header {
                position: relative;
            }
            
            .menu-toggle {
                display: block;
                font-size: 20px;
                cursor: pointer;
            }
        }
        
        @media (min-width: 769px) {
            .menu-toggle {
                display: none;
            }
        }
        
        /* Ê¨¢ËøéÊ∂àÊÅØ */
        .welcome-message {
            background: #e8f5e9;
            padding: 10px 20px;
            border-radius: 20px;
            text-align: center;
            color: #2e7d32;
            font-size: 14px;
            margin: 10px auto;
            max-width: 80%;
            animation: pulse 2s infinite;
        }
        
        /* Áä∂ÊÄÅÊ∂àÊÅØ */
        .status-message {
            background: rgba(255, 255, 255, 0.1);
            padding: 8px 16px;
            border-radius: 15px;
            text-align: center;
            font-size: 13px;
            margin: 8px auto;
            max-width: 70%;
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.2);
            animation: fadeIn 0.5s ease;
        }
        
        @keyframes pulse {
            0% { opacity: 0.8; }
            50% { opacity: 1; }
            100% { opacity: 0.8; }
        }
        
        /* ÊèêÁ§∫ÊñáÊú¨ */
        .typing-indicator {
            font-style: italic;
            color: #999;
            font-size: 14px;
            align-self: flex-start;
            margin-left: 40px;
        }
        
        /* Èü≥‰πêÂç°ÁâáÊ†∑Âºè */
        .music-card {
            background: linear-gradient(135deg, #FF6B9D, #C44569);
            border-radius: 12px;
            padding: 15px;
            margin-top: 10px;
            color: white;
            box-shadow: 0 4px 12px rgba(255,107,157,0.3);
        }
        
        .music-info {
            margin-bottom: 10px;
        }
        
        .music-title {
            font-size: 16px;
            font-weight: bold;
            margin-bottom: 5px;
        }
        
        .music-artist {
            font-size: 14px;
            opacity: 0.9;
            margin-bottom: 3px;
        }
        
        .music-album {
            font-size: 12px;
            opacity: 0.8;
        }
        
        .music-controls {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-top: 10px;
            padding-top: 10px;
            border-top: 1px solid rgba(255,255,255,0.2);
        }
        
        .play-music-btn {
            background: rgba(255,255,255,0.2);
            border: none;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            font-size: 18px;
            color: white;
            cursor: pointer;
            transition: all 0.2s ease;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        .play-music-btn:hover {
            background: rgba(255,255,255,0.3);
            transform: scale(1.05);
        }
        
        .no-audio {
            color: rgba(255,255,255,0.6);
            font-size: 12px;
        }
        
        .music-timestamp {
            font-size: 11px;
            opacity: 0.7;
        }
        
        /* ÂÖ®Â±ÄÈü≥‰πêÊí≠ÊîæÂô®Ê†∑Âºè */
        .global-music-player {
            position: fixed;
            bottom: 20px;
            right: 20px;
            background: linear-gradient(135deg, #FF6B9D, #C44569);
            border-radius: 15px;
            padding: 15px;
            color: white;
            box-shadow: 0 8px 25px rgba(255,107,157,0.4);
            z-index: 1000;
            min-width: 280px;
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255,255,255,0.1);
        }
        
        .global-player-info {
            margin-bottom: 10px;
        }
        
        .global-player-title {
            font-size: 16px;
            font-weight: bold;
            margin-bottom: 5px;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }
        
        .global-player-artist {
            font-size: 13px;
            opacity: 0.9;
            margin-bottom: 5px;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }
        
        .global-player-status {
            font-size: 11px;
            opacity: 0.7;
        }
        
        .global-player-controls {
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .control-btn {
            background: rgba(255,255,255,0.2);
            border: none;
            border-radius: 8px;
            padding: 8px;
            color: white;
            cursor: pointer;
            transition: all 0.2s ease;
            font-size: 14px;
            width: 32px;
            height: 32px;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        .control-btn:hover {
            background: rgba(255,255,255,0.3);
            transform: scale(1.05);
        }
        
        .music-player audio {
            width: 100%;
            height: 32px;
            border-radius: 16px;
            outline: none;
        }
        
        /* Â§©Ê∞îÂç°ÁâáÊ†∑Âºè */
        .weather-card {
            background: linear-gradient(135deg, #74B9FF, #0984E3);
            border-radius: 12px;
            padding: 15px;
            margin-top: 10px;
            color: white;
            box-shadow: 0 4px 12px rgba(116,185,255,0.3);
        }
        
        .weather-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
        }
        
        .weather-city {
            font-size: 16px;
            font-weight: bold;
        }
        
        .weather-time {
            font-size: 12px;
            opacity: 0.8;
        }
        
        .weather-main {
            display: flex;
            align-items: center;
            margin-bottom: 10px;
        }
        
        .weather-temp {
            font-size: 24px;
            font-weight: bold;
            margin-right: 15px;
        }
        
        .weather-desc {
            font-size: 14px;
        }
        
        .weather-details {
            display: flex;
            gap: 15px;
        }
        
        .weather-detail {
            display: flex;
            flex-direction: column;
            align-items: center;
            font-size: 12px;
        }
        
        .detail-label {
            opacity: 0.8;
            margin-bottom: 2px;
        }
        
        .detail-value {
            font-weight: bold;
        }
    </style>
</head>
<body>
    <div class="chat-container">
        <!-- ‰æßËæπÊ†è -->
        <div class="sidebar">
            <div class="sidebar-header">
                <h2>DaiPËÅäÂ§©</h2>
                <p>Êô∫ËÉΩ‰∫§ÊµÅÁ©∫Èó¥</p>
            </div>
            <div class="online-users">
                <div class="section-title">Âú®Á∫øÁî®Êà∑</div>
                <ul class="user-list" id="user-list">
                    <!-- Âú®Á∫øÁî®Êà∑ÂàóË°®Â∞ÜÈÄöËøáJavaScriptÂä®ÊÄÅÊ∑ªÂä† -->
                </ul>
            </div>
        </div>
        
        <!-- ËÅäÂ§©Âå∫Âüü -->
        <div class="chat-area">
            <div class="chat-header">
                <span class="menu-toggle" onclick="toggleSidebar()">‚ò∞</span>
                <h2>ËÅäÂ§©ÂÆ§</h2>
                <div>
                    <button class="history-btn" id="history-btn" onclick="showHistoryModal()">ÂéÜÂè≤ËÆ∞ÂΩï</button>
                    <button class="status-btn" id="status-btn" onclick="toggleStatus()">Âú®Á∫ø</button>
                    <button class="logout-btn" id="logout-btn">ÈÄÄÂá∫</button>
                </div>
            </div>
            
            <div class="messages-container" id="messages-container">
                <div class="welcome-message">Ê¨¢ËøéÊù•Âà∞DaiPÊô∫ËÉΩËÅäÂ§©ÂÆ§ÔºÅ‰ΩøÁî®@ÂëΩ‰ª§ÂèØ‰ª•ËøõË°åÁâπÊÆäÊìç‰ΩúÔºåÂ¶Ç@Â∑ùÂ∞èÂÜú‰∏éAIÂØπËØùÔºå@ÁîµÂΩ±URLÂàÜ‰∫´ÁîµÂΩ±„ÄÇÁÇπÂáªü§ñÊåâÈíÆÂèØÂø´ÈÄüÂºÄÂßã‰∏éÂ∑ùÂ∞èÂÜúÂØπËØùÔºÅ</div>
            </div>
            
            <!-- ÂéÜÂè≤ËÆ∞ÂΩïÊ®°ÊÄÅÊ°Ü -->
            <div id="history-modal" class="history-modal">
                <div class="history-content">
                    <div class="history-header">
                        <h3>ËÅäÂ§©ÂéÜÂè≤ËÆ∞ÂΩï</h3>
                        <button class="close-history" onclick="closeHistoryModal()">√ó</button>
                    </div>
                    <div id="history-body" class="history-body">
                        <div class="no-history">Âä†ËΩΩ‰∏≠...</div>
                    </div>
                </div>
            </div>
            
            <div class="input-area">
                <button class="emoji-btn" id="emoji-btn">üòä</button>
                <button class="ai-btn" id="ai-btn" title="‰∏éÂ∑ùÂ∞èÂÜúAIÂØπËØù">
                    ü§ñ
                </button>
                <button class="music-btn" id="music-btn" title="Ëé∑ÂèñÈöèÊú∫Èü≥‰πê">
                    üéµ
                </button>
                <button class="weather-btn" id="weather-btn" title="Êü•ÁúãÂ§©Ê∞î‰ø°ÊÅØ">
                    üå§Ô∏è
                </button>
                <button class="news-btn" id="news-btn" title="Êü•ÁúãÊúÄÊñ∞Êñ∞Èóª">
                    üì∞
                </button>
                <textarea class="message-input" id="message-input" placeholder="ËæìÂÖ•Ê∂àÊÅØ..." rows="1"></textarea>
                <button class="send-btn" id="send-btn">‚Üí</button>
                <div class="emoji-panel" id="emoji-panel">
                    <!-- Ë°®ÊÉÖÂåÖÂ∞ÜÈÄöËøáJavaScriptÂä®ÊÄÅÊ∑ªÂä† -->
                </div>
            </div>
        </div>
    </div>
    
    <!-- ÂºπÂá∫Èü≥‰πêÂç°Áâá -->
    <div class="overlay" id="music-overlay"></div>
    <div class="popup-music-card" id="popup-music-card">
        <div class="popup-music-header">
            <div class="popup-music-info">
                <div class="popup-music-title" id="popup-music-title">üéµ ÈÄâÊã©Èü≥‰πê</div>
                <div class="popup-music-artist" id="popup-music-artist">ÁÇπÂáª‰∏ãÊñπÊåâÈíÆËé∑ÂèñÈöèÊú∫Èü≥‰πê</div>
            </div>
            <button class="close-popup-btn" id="close-popup-btn">‚úñÔ∏è</button>
        </div>
        <div class="music-album-art" id="music-album-art">üíø</div>
        <div class="music-progress" id="music-progress" style="display: none;">
            <div class="progress-bar" id="progress-bar">
                <div class="progress-fill" id="progress-fill"></div>
            </div>
            <div class="progress-time">
                <span id="current-time">00:00</span>
                <span id="total-time">00:00</span>
            </div>
        </div>
        <div class="popup-music-controls">
            <button class="popup-control-btn" id="prev-btn" title="‰∏ä‰∏ÄÈ¶ñ">‚èÆÔ∏è</button>
            <button class="popup-control-btn popup-play-btn" id="popup-play-btn" title="Êí≠Êîæ/ÊöÇÂÅú">‚ñ∂Ô∏è</button>
            <button class="popup-control-btn" id="next-btn" title="‰∏ã‰∏ÄÈ¶ñ">‚è≠Ô∏è</button>
        </div>
        <div class="popup-music-controls">
            <button class="popup-control-btn popup-qqmusic-btn" id="qq-music-btn">
                üéµ QQÈü≥‰πê
            </button>
            <button class="popup-control-btn random-btn" id="random-btn" title="ÈöèÊú∫Èü≥‰πê">
                üé≤ ÈöèÊú∫
            </button>
        </div>
    </div>
    
    <!-- Êñ∞ÈóªÊ®°ÊÄÅÊ°ÜÂ∞ÜÁî±news_display.jsÂä®ÊÄÅÁîüÊàê -->
    
    <script src="https://cdn.socket.io/4.6.0/socket.io.min.js"></script>
    <script src="{{ url_for('static', filename='js/news_display.js') }}"></script>
    <script>
        const nickname = new URLSearchParams(window.location.search).get('nickname');
        
        // Â¶ÇÊûúÊ≤°ÊúâÊòµÁß∞ÔºåËøîÂõûÁôªÂΩïÈ°µ
        if (!nickname) {
            window.location.href = '/';
        }
        
        // Socket.IOËøûÊé•
        const socket = io();
        
        // DOMÂÖÉÁ¥†
        const messagesContainer = document.getElementById('messages-container');
        const messageInput = document.getElementById('message-input');
        const sendBtn = document.getElementById('send-btn');
        const logoutBtn = document.getElementById('logout-btn');
        const userList = document.getElementById('user-list');
        
        // Ë∞ÉÊï¥ÊñáÊú¨ÂüüÈ´òÂ∫¶
        messageInput.addEventListener('input', () => {
            messageInput.style.height = 'auto';
            messageInput.style.height = Math.min(messageInput.scrollHeight, 100) + 'px';
        });
        
        // ÂèëÈÄÅÊ∂àÊÅØ
        function sendMessage() {
            const message = messageInput.value.trim();
            if (message) {
                socket.emit('send_message', {
                    nickname: nickname,
                    message: message
                });
                messageInput.value = '';
                messageInput.style.height = 'auto';
            }
        }
        
        // ÂèëÈÄÅÊåâÈíÆÁÇπÂáª
        sendBtn.addEventListener('click', sendMessage);
        
        // ÊåâEnterÂèëÈÄÅÔºåShift+EnterÊç¢Ë°å
        messageInput.addEventListener('keydown', (e) => {
            if (e.key === 'Enter' && !e.shiftKey) {
                e.preventDefault();
                sendMessage();
            }
        });
        
        // ÈÄÄÂá∫ËÅäÂ§©ÂÆ§
        logoutBtn.addEventListener('click', () => {
            socket.emit('leave_room', { nickname: nickname });
            window.location.href = '/';
        });
        
        // ÂàáÊç¢‰æßËæπÊ†èÔºàÁßªÂä®Á´ØÔºâ
        function toggleSidebar() {
            document.querySelector('.sidebar').classList.toggle('active');
        }
        
        // DOMÂÖÉÁ¥†
        const emojiBtn = document.getElementById('emoji-btn');
        const emojiPanel = document.getElementById('emoji-panel');
        const aiBtn = document.getElementById('ai-btn');
        const musicBtn = document.getElementById('music-btn');
        const weatherBtn = document.getElementById('weather-btn');
        const newsBtn = document.getElementById('news-btn');
        
        // Ë°®ÊÉÖÂåÖÊï∞ÊçÆ
        const emojiList = [
            'üòä', 'üòÇ', 'üòç', 'üòé', 'üò¢', 'üò°', 'üëç', 'üëé', '‚ù§Ô∏è', 'üéâ',
            'ü§î', 'üò¥', 'üò∑', 'ü§ó', 'üòò', 'ü§£', 'üò±', 'ü§©', 'üôÑ', 'üòè',
            'üòÅ', 'üòÜ', 'üòã', 'üòâ', 'üòå', 'üò≠', 'üò§', 'üëè', 'üôå', 'üëã',
            'üëçüèª', 'üëéüèª', '‚ù§Ô∏è', 'üß°', 'üíõ', 'üíö', 'üíô', 'üíú', 'üñ§', 'ü§ç',
            'üî•', '‚ú®', '‚≠ê', 'üåü', 'üåà', 'üå∫', 'üå∏', 'üåπ', 'üå∑', 'üåº'
        ];
        
        // ÂàùÂßãÂåñË°®ÊÉÖÂåÖÈù¢Êùø
        function initEmojiPanel() {
            emojiList.forEach(emoji => {
                const emojiItem = document.createElement('button');
                emojiItem.className = 'emoji-item';
                emojiItem.textContent = emoji;
                emojiItem.title = emoji;
                emojiItem.addEventListener('click', () => {
                    insertEmoji(emoji);
                });
                emojiPanel.appendChild(emojiItem);
            });
        }
        
        // ÂàùÂßãÂåñË°®ÊÉÖÂåÖÈù¢Êùø
        initEmojiPanel();
        
        // ÂàáÊç¢Ë°®ÊÉÖÂåÖÈù¢ÊùøÊòæÁ§∫/ÈöêËóè
        function toggleEmojiPanel() {
            emojiPanel.classList.toggle('active');
        }
        
        // Ê∑ªÂä†Ë°®ÊÉÖÂåÖÁÇπÂáª‰∫ã‰ª∂
        emojiBtn.addEventListener('click', (e) => {
            e.stopPropagation(); // ÈòªÊ≠¢ÂÜíÊ≥°
            toggleEmojiPanel();
        });
        
        // AIÊåâÈíÆÁÇπÂáª‰∫ã‰ª∂ - Âø´ÈÄü@Â∑ùÂ∞èÂÜú
        aiBtn.addEventListener('click', () => {
            insertAiPrefix();
        });
        
        // Èü≥‰πêÊåâÈíÆÁÇπÂáª‰∫ã‰ª∂ - Ëé∑ÂèñÈöèÊú∫Èü≥‰πê
        musicBtn.addEventListener('click', () => {
            getRandomMusic();
        });
        
        // Â§©Ê∞îÊåâÈíÆÁÇπÂáª‰∫ã‰ª∂ - Êü•ÁúãÂ§©Ê∞î‰ø°ÊÅØ
        weatherBtn.addEventListener('click', () => {
            showCitySearchDialog();
        });
        
        // Êñ∞ÈóªÊåâÈíÆÁÇπÂáª‰∫ã‰ª∂ - Êü•ÁúãÊúÄÊñ∞Êñ∞Èóª
        newsBtn.addEventListener('click', () => {
            newsDisplay.showNewsModal();
        });
        
        // ÊèíÂÖ•@Â∑ùÂ∞èÂÜúÂâçÁºÄ
        function insertAiPrefix() {
            const aiPrefix = '@Â∑ùÂ∞èÂÜú ';
            const start = messageInput.selectionStart;
            const end = messageInput.selectionEnd;
            const text = messageInput.value;
            
            // Â¶ÇÊûúËæìÂÖ•Ê°Ü‰∏∫Á©∫ÊàñÂÖâÊ†áÂú®ÂºÄÂ§¥ÔºåÁõ¥Êé•ÊèíÂÖ•
            if (text.length === 0 || start === 0) {
                messageInput.value = aiPrefix + text;
                messageInput.setSelectionRange(aiPrefix.length, aiPrefix.length);
            } else {
                // Âú®ÂÖâÊ†á‰ΩçÁΩÆÊèíÂÖ•
                messageInput.value = text.substring(0, start) + aiPrefix + text.substring(end);
                messageInput.setSelectionRange(start + aiPrefix.length, start + aiPrefix.length);
            }
            
            // ËÅöÁÑ¶ËæìÂÖ•Ê°ÜÂπ∂Ë∞ÉÊï¥È´òÂ∫¶
            messageInput.focus();
            messageInput.style.height = 'auto';
            messageInput.style.height = Math.min(messageInput.scrollHeight, 100) + 'px';
            
            // Ëß¶ÂèëËæìÂÖ•‰∫ã‰ª∂‰ª•Êõ¥Êñ∞ËæìÂÖ•Ê°ÜÊ†∑Âºè
            messageInput.dispatchEvent(new Event('input'));
        }
        
        // ÊèíÂÖ•Ë°®ÊÉÖÂåÖÂà∞ËæìÂÖ•Ê°Ü
        function insertEmoji(emoji) {
            const start = messageInput.selectionStart;
            const end = messageInput.selectionEnd;
            const text = messageInput.value;
            
            // Âú®ÂÖâÊ†á‰ΩçÁΩÆÊèíÂÖ•Ë°®ÊÉÖ
            messageInput.value = text.substring(0, start) + emoji + text.substring(end);
            
            // Êõ¥Êñ∞ÂÖâÊ†á‰ΩçÁΩÆ
            const newCursorPos = start + emoji.length;
            messageInput.setSelectionRange(newCursorPos, newCursorPos);
            
            // ËÅöÁÑ¶ËæìÂÖ•Ê°ÜÂπ∂Ë∞ÉÊï¥È´òÂ∫¶
            messageInput.focus();
            messageInput.style.height = 'auto';
            messageInput.style.height = Math.min(messageInput.scrollHeight, 100) + 'px';
        }
        
        // ÁÇπÂáªÈ°µÈù¢ÂÖ∂‰ªñÂú∞ÊñπÂÖ≥Èó≠Ë°®ÊÉÖÂåÖÈù¢Êùø
        document.addEventListener('click', () => {
            if (emojiPanel.classList.contains('active')) {
                emojiPanel.classList.remove('active');
            }
        });
        
        // ÈòªÊ≠¢ÁÇπÂáªË°®ÊÉÖÂåÖÈù¢ÊùøÊó∂ÂÖ≥Èó≠
        emojiPanel.addEventListener('click', (e) => {
            e.stopPropagation();
        });
        
        // ÁîüÊàêÁî®Êà∑Â§¥ÂÉèÁöÑÈ¶ñÂ≠óÊØç
        function getInitial(name) {
            return name.charAt(0).toUpperCase();
        }
        
        // ÂéÜÂè≤ËÆ∞ÂΩïÁõ∏ÂÖ≥ÂáΩÊï∞
        function showHistoryModal() {
            const historyModal = document.getElementById('history-modal');
            historyModal.classList.add('active');
            loadHistory();
        }
        
        function closeHistoryModal() {
            const historyModal = document.getElementById('history-modal');
            historyModal.classList.remove('active');
        }
        
        async function loadHistory() {
            try {
                const historyBody = document.getElementById('history-body');
                historyBody.innerHTML = '<div class="no-history">Ê≠£Âú®Âä†ËΩΩÂéÜÂè≤ËÆ∞ÂΩï...</div>';
                
                const response = await fetch(`/api/history?nickname=${encodeURIComponent(nickname)}&page=1&page_size=50`);
                const result = await response.json();
                
                if (result.success) {
                    displayHistory(result.data);
                } else {
                    historyBody.innerHTML = '<div class="no-history">Âä†ËΩΩÂéÜÂè≤ËÆ∞ÂΩïÂ§±Ë¥•Ôºö' + (result.error || 'Êú™Áü•ÈîôËØØ') + '</div>';
                }
            } catch (error) {
                console.error('Âä†ËΩΩÂéÜÂè≤ËÆ∞ÂΩïÂ§±Ë¥•:', error);
                const historyBody = document.getElementById('history-body');
                historyBody.innerHTML = '<div class="no-history">Âä†ËΩΩÂéÜÂè≤ËÆ∞ÂΩïÊó∂ÂèëÁîüÁΩëÁªúÈîôËØØ</div>';
            }
        }
        
        function displayHistory(messages) {
            const historyBody = document.getElementById('history-body');
            
            if (!messages || messages.length === 0) {
                historyBody.innerHTML = '<div class="no-history">ÊöÇÊó†ËÅäÂ§©ËÆ∞ÂΩï</div>';
                return;
            }
            
            historyBody.innerHTML = '';
            
            messages.forEach(message => {
                const historyMessage = document.createElement('div');
                historyMessage.className = `history-message ${message.nickname === nickname ? 'own' : 'other'} ${message.is_ai_response ? 'ai' : ''}`;
                
                const timestamp = new Date(message.created_at).toLocaleString('zh-CN');
                
                historyMessage.innerHTML = `
                    <div class="message-header">
                        <div class="message-avatar" style="background-color: ${message.is_ai_response ? '#4caf50' : (message.nickname === nickname ? '#764ba2' : '#667eea')}">
                            ${getInitial(message.nickname)}
                        </div>
                        <span class="message-username">${message.nickname}</span>
                    </div>
                    <div class="message-content">${message.message}</div>
                    <div class="history-time">${timestamp}</div>
                `;
                
                historyBody.appendChild(historyMessage);
            });
            
            // ÊªöÂä®Âà∞Â∫ïÈÉ®
            historyBody.scrollTop = historyBody.scrollHeight;
        }
        
        // ÁÇπÂáªÊ®°ÊÄÅÊ°ÜÂ§ñÈÉ®ÂÖ≥Èó≠
        document.getElementById('history-modal').addEventListener('click', function(e) {
            if (e.target === this) {
                closeHistoryModal();
            }
        });
        
        // Ê∑ªÂä†Ê∂àÊÅØÂà∞ËÅäÂ§©Âå∫Âüü
        function addMessage(data) {
            const messageDiv = document.createElement('div');
            messageDiv.className = `message ${data.nickname === nickname ? 'own' : 'other'} ${data.is_ai ? 'ai' : ''} ${data.is_at ? 'at' : ''} ${data.is_movie ? 'movie' : ''} ${data.is_music ? 'music' : ''} ${data.is_weather ? 'weather' : ''}`;
            
            let avatarColor = '';
            if (data.is_ai) {
                avatarColor = '#4caf50';
            } else if (data.nickname === nickname) {
                avatarColor = '#764ba2';
            } else {
                avatarColor = '#667eea';
            }
            
            let extraContent = '';
            
            // ÁîµÂΩ±ÂÜÖÂÆπ
            if (data.is_movie && data.movie_url) {
                extraContent += `
                <div class="movie-player">
                    <iframe src="${data.movie_url}" allowfullscreen></iframe>
                </div>
                `;
            }
            
            // Èü≥‰πêÂÜÖÂÆπ
            if (data.is_music && data.music_data) {
                const music = typeof data.music_data === 'string' ? JSON.parse(data.music_data) : data.music_data;
                const isCurrentMusic = currentPlayingMusic && currentPlayingMusic.name === music.name && currentPlayingMusic.singer === music.singer;
                const playButtonText = isCurrentMusic && isPlaying ? '‚è∏Ô∏è' : '‚ñ∂Ô∏è';
                
                extraContent += `
                <div class="music-card" data-music='${JSON.stringify(music)}'>
                    <div class="music-info">
                        <div class="music-title">üéµ ${music.name || 'Êú™Áü•Ê≠åÊõ≤'}</div>
                        <div class="music-artist">${music.singer || 'Êú™Áü•Ê≠åÊâã'}</div>
                        ${music.album ? `<div class="music-album">‰∏ìËæëÔºö${music.album}</div>` : ''}
                    </div>
                    <div class="music-controls">
                        ${music.url ? `
                        <button class="play-music-btn" onclick="handleMusicCardPlay('${JSON.stringify(music).replace(/'/g, "\\'")}')" 
                                title="${isCurrentMusic && isPlaying ? 'ÊöÇÂÅúÊí≠Êîæ' : 'Êí≠ÊîæÈü≥‰πê'}">
                            ${playButtonText}
                        </button>
                        ` : '<span class="no-audio">Êó†Èü≥È¢ë</span>'}
                        <span class="music-timestamp">${new Date().toLocaleTimeString()}</span>
                    </div>
                </div>
                `;
            }
            
            // Â§©Ê∞îÂÜÖÂÆπ
            if (data.is_weather && data.weather_data) {
                const weather = typeof data.weather_data === 'string' ? JSON.parse(data.weather_data) : data.weather_data;
                extraContent += `
                <div class="weather-card">
                    <div class="weather-header">
                        <div class="weather-city">üåç ${weather.city || 'Êú™Áü•ÂüéÂ∏Ç'}</div>
                        <div class="weather-time">${weather.update_time || ''}</div>
                    </div>
                    <div class="weather-main">
                        <div class="weather-temp">${weather.temperature || 'Êú™Áü•'}</div>
                        <div class="weather-desc">${weather.icon || ''} ${weather.condition || 'Êú™Áü•'}</div>
                    </div>
                    <div class="weather-details">
                        <div class="weather-detail">
                            <span class="detail-label">ÊπøÂ∫¶</span>
                            <span class="detail-value">${weather.humidity || 0}%</span>
                        </div>
                        <div class="weather-detail">
                            <span class="detail-label">È£éÈÄü</span>
                            <span class="detail-value">${weather.wind || 'Êú™Áü•'}</span>
                        </div>
                    </div>
                </div>
                `;
            }
            
            messageDiv.innerHTML = `
                <div class="message-header">
                    <div class="message-avatar" style="background-color: ${avatarColor}">
                        ${getInitial(data.nickname)}
                    </div>
                    <span class="message-username">${data.nickname}</span>
                </div>
                <div class="message-content">${data.message}</div>
                ${extraContent}
            `;
            
            messagesContainer.appendChild(messageDiv);
            messagesContainer.scrollTop = messagesContainer.scrollHeight;
        }
        
        // Êõ¥Êñ∞Âú®Á∫øÁî®Êà∑ÂàóË°®
        function updateUserList(users) {
            userList.innerHTML = '';
            users.forEach(user => {
                const isCurrentUser = user === nickname;
                const userItem = document.createElement('li');
                userItem.className = 'user-item';
                userItem.innerHTML = `
                    <div class="user-avatar" style="background-color: ${isCurrentUser ? '#764ba2' : '#667eea'}">
                        ${getInitial(user)}
                    </div>
                    <div class="user-info">
                        <div class="user-name">${user} ${isCurrentUser ? '(Êàë)' : ''}</div>
                        <div class="user-status">Âú®Á∫ø</div>
                    </div>
                `;
                userList.appendChild(userItem);
            });
        }
        
        // Áî®Êà∑Áä∂ÊÄÅÁÆ°ÁêÜ
        let userStatus = 'online'; // 'online' Êàñ 'offline'
        
        function toggleStatus() {
            userStatus = userStatus === 'online' ? 'offline' : 'online';
            updateStatusUI();
            sendStatusUpdate();
        }
        
        function updateStatusUI() {
            const statusBtn = document.getElementById('status-btn');
            if (userStatus === 'online') {
                statusBtn.textContent = 'Âú®Á∫ø';
                statusBtn.className = 'status-btn online';
            } else {
                statusBtn.textContent = 'Á¶ªÁ∫ø';
                statusBtn.className = 'status-btn offline';
            }
        }
        
        function sendStatusUpdate() {
            // ÂèëÈÄÅÁä∂ÊÄÅÊõ¥Êñ∞Âà∞ÊúçÂä°Âô®
            fetch('/api/user/status', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                    username: nickname,
                    status: userStatus
                })
            })
            .then(response => response.json())
            .then(result => {
                if (result.success) {
                    // Êõ¥Êñ∞ÂΩìÂâçÁî®Êà∑Âú®Âú®Á∫øÂàóË°®‰∏≠ÁöÑÁä∂ÊÄÅ
                    const currentUserItem = document.querySelector('.user-item:contains("(Êàë)")');
                    if (currentUserItem) {
                        const statusElement = currentUserItem.querySelector('.user-status');
                        if (statusElement) {
                            statusElement.textContent = userStatus === 'online' ? 'Âú®Á∫ø' : 'Á¶ªÁ∫ø';
                        }
                    }
                }
            })
            .catch(error => {
                console.error('Êõ¥Êñ∞Áä∂ÊÄÅÂ§±Ë¥•:', error);
            });
        }
        
        // Socket.IO‰∫ã‰ª∂ÁõëÂê¨
        socket.on('connect', () => {
            console.log('Connected to server');
            socket.emit('join_room', { nickname: nickname });
            // ËøûÊé•Êó∂ÈªòËÆ§ËÆæÁΩÆ‰∏∫Âú®Á∫øÁä∂ÊÄÅ
            userStatus = 'online';
            updateStatusUI();
            sendStatusUpdate();
        });
        
        socket.on('welcome', (data) => {
            const welcomeMsg = document.createElement('div');
            welcomeMsg.className = 'welcome-message';
            welcomeMsg.textContent = data.message;
            messagesContainer.appendChild(welcomeMsg);
            updateUserList(data.online_users);
        });
        
        socket.on('new_message', (data) => {
            addMessage(data);
        });
        
        socket.on('music_control', (data) => {
            // ÂêåÊ≠•ÂÖ∂‰ªñÁî®Êà∑ÁöÑÈü≥‰πêÊí≠ÊîæÁä∂ÊÄÅ
            if (data.user !== nickname) { // ‰∏çÂ§ÑÁêÜËá™Â∑±ÁöÑ‰∫ã‰ª∂
                switch (data.action) {
                    case 'play':
                        if (data.music_data && data.music_data.url) {
                            playMusic(data.music_data, false); // ‰∏çÁ´ãÂç≥Êí≠ÊîæÔºåÂè™ÂêåÊ≠•Áä∂ÊÄÅ
                            updateMusicCardUI(data.music_data, 'playing');
                        }
                        break;
                    case 'pause':
                        if (globalAudioPlayer) {
                            globalAudioPlayer.pause();
                        }
                        updateMusicCardUI(data.music_data, 'paused');
                        break;
                    case 'stop':
                        if (globalAudioPlayer) {
                            globalAudioPlayer.pause();
                            globalAudioPlayer.currentTime = 0;
                        }
                        updateMusicCardUI(null, 'stopped');
                        break;
                    case 'end':
                        updateMusicCardUI(data.music_data, 'stopped');
                        break;
                }
            }
        });
        
        socket.on('weather_update', (data) => {
            // ÂêåÊ≠•Â§©Ê∞îËÉåÊôØ
            if (data.weather_data) {
                applyWeatherTheme(data.weather_data);
            }
        });
        
        socket.on('user_left', (data) => {
            const leaveMsg = document.createElement('div');
            leaveMsg.className = 'welcome-message';
            leaveMsg.textContent = data.message;
            messagesContainer.appendChild(leaveMsg);
            updateUserList(data.online_users);
        });
        
        // ÁõëÂê¨Áî®Êà∑Áä∂ÊÄÅÂèòÂåñ‰∫ã‰ª∂
        socket.on('user_status_change', (data) => {
            console.log('Êî∂Âà∞Áî®Êà∑Áä∂ÊÄÅÂèòÂåñ:', data);
            
            // ÊòæÁ§∫Áä∂ÊÄÅÂèòÂåñÈÄöÁü•
            const statusMsg = document.createElement('div');
            statusMsg.className = 'status-message';
            
            if (data.status === 'online') {
                statusMsg.textContent = `üü¢ ${data.nickname} ‰∏äÁ∫ø‰∫Ü`;
                statusMsg.style.color = '#4CAF50';
            } else {
                statusMsg.textContent = `üî¥ ${data.nickname} ‰∏ãÁ∫ø‰∫Ü`;
                statusMsg.style.color = '#F44336';
            }
            
            messagesContainer.appendChild(statusMsg);
            
            // Êõ¥Êñ∞Âú®Á∫øÁî®Êà∑ÂàóË°®
            updateUserList(data.online_users);
            
            // ÊªöÂä®Âà∞Â∫ïÈÉ®
            messagesContainer.scrollTop = messagesContainer.scrollHeight;
        });
        
        socket.on('disconnect', () => {
            console.log('Disconnected from server');
        });
        
        // Á™óÂè£ÂÖ≥Èó≠Êó∂ÂèëÈÄÅÁ¶ªÂºÄ‰∫ã‰ª∂
        window.addEventListener('beforeunload', () => {
            socket.emit('leave_room', { nickname: nickname });
        });
        
        // ÂÖ®Â±ÄÈü≥È¢ëÁä∂ÊÄÅÁÆ°ÁêÜ
        let currentPlayingMusic = null;
        let isPlaying = false;
        let globalAudioPlayer = null;
        let globalProgressInterval = null;

        // Ëé∑ÂèñÈöèÊú∫Èü≥‰πê
        async function getRandomMusic() {
            try {
                const response = await fetch('/api/music/random');
                const result = await response.json();
                
                if (result.success) {
                    const music = result.data;
                    const message = `ÂàÜ‰∫´‰∏ÄÈ¶ñÂ•ΩÂê¨ÁöÑÈü≥‰πêÔºöüéµ ${music.name} - ${music.singer}`;
                    
                    socket.emit('send_message', {
                        nickname: nickname,
                        message: message,
                        message_type: 'music',
                        is_music: true,
                        music_data: JSON.stringify(music)
                    });
                } else {
                    alert('Ëé∑ÂèñÈü≥‰πêÂ§±Ë¥•Ôºö' + (result.error || 'Êú™Áü•ÈîôËØØ'));
                }
            } catch (error) {
                console.error('Ëé∑ÂèñÈü≥‰πêÂ§±Ë¥•:', error);
                alert('Ëé∑ÂèñÈü≥‰πêÊó∂ÂèëÁîüÁΩëÁªúÈîôËØØ');
            }
        }

        // Êí≠ÊîæÈü≥‰πê
        function playMusic(musicData, playImmediately = false) {
            if (!musicData.url) {
                alert('ËØ•Èü≥‰πêÊ≤°ÊúâÈü≥È¢ëÈìæÊé•');
                return;
            }

            // ÂÅúÊ≠¢ÂΩìÂâçÊí≠Êîæ
            if (globalAudioPlayer) {
                globalAudioPlayer.pause();
                globalAudioPlayer.currentTime = 0;
            }

            // ÂàõÂª∫Êñ∞ÁöÑÈü≥È¢ëÊí≠ÊîæÂô®
            globalAudioPlayer = new Audio(musicData.url);
            globalAudioPlayer.volume = 0.7;
            
            // ËÆæÁΩÆÈü≥È¢ëÈ¢ÑÂä†ËΩΩÂ±ûÊÄß
            globalAudioPlayer.preload = 'auto';
            
            // Ê∑ªÂä†‰∫ã‰ª∂ÁõëÂê¨
            globalAudioPlayer.addEventListener('loadstart', () => {
                updateGlobalPlayerUI(musicData, 'loading');
            });

            globalAudioPlayer.addEventListener('loadedmetadata', () => {
                console.log('Èü≥È¢ëÂÖÉÊï∞ÊçÆÂä†ËΩΩÂÆåÊàêÔºåÊÄªÊó∂Èïø:', globalAudioPlayer.duration);
            });

            globalAudioPlayer.addEventListener('canplay', () => {
                if (playImmediately) {
                    globalAudioPlayer.play().catch(error => {
                        console.error('Êí≠ÊîæÂ§±Ë¥•:', error);
                        alert('Êí≠ÊîæÂ§±Ë¥•ÔºåËØ∑Ê£ÄÊü•Èü≥È¢ëÈìæÊé•ÊòØÂê¶ÊúâÊïà');
                    });
                }
            });

            globalAudioPlayer.addEventListener('play', () => {
                isPlaying = true;
                currentPlayingMusic = musicData;
                updateGlobalPlayerUI(musicData, 'playing');
                // ÂπøÊí≠Êí≠ÊîæÁä∂ÊÄÅ
                broadcastMusicState('play', musicData);
                // Êõ¥Êñ∞Èü≥‰πêÂç°ÁâáUI
                updateMusicCardUI(musicData, 'playing');
                // ÂºÄÂßãËøõÂ∫¶Êõ¥Êñ∞
                startGlobalProgress();
            });

            globalAudioPlayer.addEventListener('pause', () => {
                isPlaying = false;
                updateGlobalPlayerUI(musicData, 'paused');
                // ÂπøÊí≠ÊöÇÂÅúÁä∂ÊÄÅ
                broadcastMusicState('pause', musicData);
                // Êõ¥Êñ∞Èü≥‰πêÂç°ÁâáUI
                updateMusicCardUI(musicData, 'paused');
                // ÂÅúÊ≠¢ËøõÂ∫¶Êõ¥Êñ∞
                stopGlobalProgress();
            });

            globalAudioPlayer.addEventListener('ended', () => {
                isPlaying = false;
                currentPlayingMusic = null;
                updateGlobalPlayerUI(null, 'stopped');
                // ÂπøÊí≠ÁªìÊùüÁä∂ÊÄÅ
                broadcastMusicState('end', musicData);
                // Êõ¥Êñ∞Èü≥‰πêÂç°ÁâáUI
                updateMusicCardUI(null, 'stopped');
                // ÂÅúÊ≠¢ËøõÂ∫¶Êõ¥Êñ∞
                stopGlobalProgress();
            });

            globalAudioPlayer.addEventListener('error', (e) => {
                console.error('Èü≥È¢ëÊí≠ÊîæÈîôËØØ:', e);
                alert('Èü≥È¢ëÊí≠ÊîæÂ§±Ë¥•ÔºåËØ∑Ê£ÄÊü•Èü≥È¢ëÈìæÊé•ÊòØÂê¶ÊúâÊïà');
                updateGlobalPlayerUI(null, 'stopped');
                updateMusicCardUI(null, 'stopped');
                // ÂÅúÊ≠¢ËøõÂ∫¶Êõ¥Êñ∞
                stopGlobalProgress();
            });

            // È¢ÑÂä†ËΩΩÈü≥È¢ë
            globalAudioPlayer.load();
        }

        // ÊöÇÂÅú/ÊÅ¢Â§çÈü≥‰πê
        function togglePlayPause() {
            if (!globalAudioPlayer) return;

            if (globalAudioPlayer.paused) {
                globalAudioPlayer.play();
            } else {
                globalAudioPlayer.pause();
            }
        }

        // ÂÅúÊ≠¢Èü≥‰πê
        function stopMusic() {
            if (globalAudioPlayer) {
                globalAudioPlayer.pause();
                globalAudioPlayer.currentTime = 0;
                isPlaying = false;
                currentPlayingMusic = null;
                updateGlobalPlayerUI(null, 'stopped');
                // ÂπøÊí≠ÂÅúÊ≠¢Áä∂ÊÄÅ
                broadcastMusicState('stop', null);
                // ÂÅúÊ≠¢ËøõÂ∫¶Êõ¥Êñ∞
                stopGlobalProgress();
            }
        }

        // ÂºÄÂßãÂÖ®Â±ÄÈü≥È¢ëËøõÂ∫¶Êõ¥Êñ∞
        function startGlobalProgress() {
            if (globalProgressInterval) {
                clearInterval(globalProgressInterval);
            }
            
            globalProgressInterval = setInterval(() => {
                if (globalAudioPlayer && !globalAudioPlayer.paused && currentPlayingMusic) {
                    const current = Math.floor(globalAudioPlayer.currentTime);
                    const total = Math.floor(globalAudioPlayer.duration);
                    
                    if (total > 0 && current >= 0) {
                        console.log(`Êí≠ÊîæËøõÂ∫¶: ${current}/${total}Áßí (${Math.floor((current/total)*100)}%)`);
                        
                        // Â¶ÇÊûúÈü≥È¢ëÂø´ÁªìÊùü‰∫ÜÔºåÂáÜÂ§á‰∏ã‰∏ÄÈ¶ñ
                        if (current >= total - 1) {
                            console.log('Èü≥È¢ëÂç≥Â∞ÜÁªìÊùüÔºåÂáÜÂ§áÊí≠Êîæ‰∏ã‰∏ÄÈ¶ñ');
                            // Âª∂Ëøü2ÁßíÂêéÊí≠Êîæ‰∏ã‰∏ÄÈ¶ñÈöèÊú∫Èü≥‰πê
                            setTimeout(() => {
                                if (!globalAudioPlayer || globalAudioPlayer.paused) {
                                    console.log('Ëá™Âä®Êí≠Êîæ‰∏ã‰∏ÄÈ¶ñÈöèÊú∫Èü≥‰πê');
                                    getRandomMusic();
                                }
                            }, 2000);
                        }
                    }
                }
            }, 1000);
        }

        // ÂÅúÊ≠¢ÂÖ®Â±ÄÈü≥È¢ëËøõÂ∫¶Êõ¥Êñ∞
        function stopGlobalProgress() {
            if (globalProgressInterval) {
                clearInterval(globalProgressInterval);
                globalProgressInterval = null;
            }
        }

        // ÂπøÊí≠Èü≥‰πêÁä∂ÊÄÅ
        function broadcastMusicState(action, musicData) {
            socket.emit('music_control', {
                action: action,
                music_data: musicData,
                timestamp: Date.now(),
                user: nickname
            });
        }

        // Êõ¥Êñ∞ÂÖ®Â±ÄÊí≠ÊîæÂô®UI
        function updateGlobalPlayerUI(musicData, state) {
            // ÂàõÂª∫ÊàñÊõ¥Êñ∞ÂÖ®Â±ÄÊí≠ÊîæÂô®
            let globalPlayer = document.getElementById('global-music-player');
            
            if (!globalPlayer && musicData) {
                globalPlayer = document.createElement('div');
                globalPlayer.id = 'global-music-player';
                globalPlayer.className = 'global-music-player';
                document.body.appendChild(globalPlayer);
            }

            if (!musicData && state === 'stopped') {
                if (globalPlayer) {
                    globalPlayer.remove();
                }
                return;
            }

            if (globalPlayer) {
                const playButtonText = state === 'playing' ? '‚è∏Ô∏è' : '‚ñ∂Ô∏è';
                const statusText = {
                    'loading': 'Âä†ËΩΩ‰∏≠...',
                    'playing': 'Ê≠£Âú®Êí≠Êîæ',
                    'paused': 'Â∑≤ÊöÇÂÅú'
                }[state] || 'Â∞±Áª™';

                globalPlayer.innerHTML = `
                    <div class="global-player-info">
                        <div class="global-player-title">üéµ ${musicData.name || 'Êú™Áü•Ê≠åÊõ≤'}</div>
                        <div class="global-player-artist">${musicData.singer || 'Êú™Áü•Ê≠åÊâã'}</div>
                        <div class="global-player-status">${statusText}</div>
                    </div>
                    <div class="global-player-controls">
                        <button onclick="togglePlayPause()" class="control-btn">${playButtonText}</button>
                        <button onclick="stopMusic()" class="control-btn">‚èπÔ∏è</button>
                        <button onclick="document.getElementById('global-music-player').style.display='none'" class="control-btn">‚úñÔ∏è</button>
                    </div>
                `;
            }
        }

        // Â§ÑÁêÜÈü≥‰πêÂç°ÁâáÊí≠ÊîæÊåâÈíÆ
        function handleMusicCardPlay(musicJson) {
            try {
                const musicData = JSON.parse(musicJson);
                
                // Ê£ÄÊü•ÊòØÂê¶ÊòØÂΩìÂâçÊí≠ÊîæÁöÑÈü≥‰πê
                if (currentPlayingMusic && 
                    currentPlayingMusic.name === musicData.name && 
                    currentPlayingMusic.singer === musicData.singer) {
                    // ÂàáÊç¢Êí≠Êîæ/ÊöÇÂÅúÁä∂ÊÄÅ
                    togglePlayPause();
                } else {
                    // Êí≠ÊîæÊñ∞ÁöÑÈü≥‰πê
                    playMusic(musicData, true);
                }
            } catch (error) {
                console.error('Ëß£ÊûêÈü≥‰πêÊï∞ÊçÆÂ§±Ë¥•:', error);
                alert('Èü≥‰πêÊï∞ÊçÆËß£ÊûêÂ§±Ë¥•');
            }
        }

        // Êõ¥Êñ∞Èü≥‰πêÂç°ÁâáUIÁä∂ÊÄÅ
        function updateMusicCardUI(musicData, state) {
            const musicCards = document.querySelectorAll('.music-card');
            musicCards.forEach(card => {
                try {
                    const cardMusicData = JSON.parse(card.getAttribute('data-music'));
                    const isTargetMusic = musicData && 
                        cardMusicData.name === musicData.name && 
                        cardMusicData.singer === musicData.singer;
                    
                    const playButton = card.querySelector('.play-music-btn');
                    if (playButton) {
                        if (isTargetMusic && state === 'playing') {
                            playButton.textContent = '‚è∏Ô∏è';
                            playButton.title = 'ÊöÇÂÅúÊí≠Êîæ';
                        } else if (isTargetMusic && state === 'paused') {
                            playButton.textContent = '‚ñ∂Ô∏è';
                            playButton.title = 'Êí≠ÊîæÈü≥‰πê';
                        } else {
                            playButton.textContent = '‚ñ∂Ô∏è';
                            playButton.title = 'Êí≠ÊîæÈü≥‰πê';
                        }
                    }
                } catch (error) {
                    console.error('Êõ¥Êñ∞Èü≥‰πêÂç°ÁâáUIÂ§±Ë¥•:', error);
                }
            });
        }

        // ÂºπÂá∫Èü≥‰πêÂç°ÁâáÂäüËÉΩ
        const popupMusicCard = document.getElementById('popup-music-card');
        const musicOverlay = document.getElementById('music-overlay');
        const closePopupBtn = document.getElementById('close-popup-btn');
        const popupPlayBtn = document.getElementById('popup-play-btn');
        const qqMusicBtn = document.getElementById('qq-music-btn');
        const randomBtn = document.getElementById('random-btn');
        const progressBar = document.getElementById('progress-bar');
        const progressFill = document.getElementById('progress-fill');
        const currentTimeSpan = document.getElementById('current-time');
        const totalTimeSpan = document.getElementById('total-time');
        const musicProgress = document.getElementById('music-progress');
        const albumArt = document.getElementById('music-album-art');
        const popupMusicTitle = document.getElementById('popup-music-title');
        const popupMusicArtist = document.getElementById('popup-music-artist');
        
        let popupCurrentMusic = null;
        let progressUpdateInterval = null;
        let popupAudioPlayer = null;

        // ÊòæÁ§∫ÂºπÂá∫Èü≥‰πêÂç°Áâá
        function showPopupMusicCard(musicData = null) {
            popupCurrentMusic = musicData;
            if (musicData) {
                updatePopupMusicCard(musicData);
            }
            popupMusicCard.classList.add('show');
            musicOverlay.classList.add('show');
        }

        // ÈöêËóèÂºπÂá∫Èü≥‰πêÂç°Áâá
        function hidePopupMusicCard() {
            popupMusicCard.classList.remove('show');
            musicOverlay.classList.remove('show');
            stopPopupProgress();
        }

        // Êõ¥Êñ∞ÂºπÂá∫Èü≥‰πêÂç°Áâá‰ø°ÊÅØ
        function updatePopupMusicCard(musicData) {
            popupMusicTitle.textContent = `üéµ ${musicData.name || 'Êú™Áü•Ê≠åÊõ≤'}`;
            popupMusicArtist.textContent = musicData.singer || 'Êú™Áü•Ê≠åÊâã';
            
            // ÊòæÁ§∫‰∏ìËæëÂ∞ÅÈù¢ÔºàÂ¶ÇÊûúÊúâÁöÑËØùÔºâ
            if (musicData.album) {
                albumArt.innerHTML = 'üíø';
            } else {
                albumArt.innerHTML = 'üíø';
            }
            
            // Â¶ÇÊûúÊúâÈü≥È¢ëURLÔºåÊòæÁ§∫ËøõÂ∫¶Êù°
            if (musicData.url) {
                musicProgress.style.display = 'block';
                popupPlayBtn.textContent = '‚ñ∂Ô∏è';
                popupPlayBtn.title = 'Êí≠ÊîæÈü≥‰πê';
            } else {
                musicProgress.style.display = 'none';
                popupPlayBtn.textContent = '‚ùå';
                popupPlayBtn.title = 'Êó†Èü≥È¢ë';
            }
        }

        // ÊâìÂºÄQQÈü≥‰πêÊí≠ÊîæÂô®
        function openQQMusicPlayer() {
            window.open('https://y.qq.com/n/ryqq_v2/player', '_blank');
        }

        // ÂºÄÂßãÂºπÂá∫Èü≥‰πêÊí≠ÊîæËøõÂ∫¶Êõ¥Êñ∞
        function startPopupProgress() {
            if (!popupAudioPlayer || !popupCurrentMusic) return;
            
            progressUpdateInterval = setInterval(() => {
                if (popupAudioPlayer && !popupAudioPlayer.paused) {
                    const current = Math.floor(popupAudioPlayer.currentTime);
                    const total = Math.floor(popupAudioPlayer.duration);
                    
                    if (total > 0) {
                        const progress = (current / total) * 100;
                        progressFill.style.width = `${progress}%`;
                        currentTimeSpan.textContent = formatTime(current);
                        totalTimeSpan.textContent = formatTime(total);
                    }
                }
            }, 1000);
        }

        // ÂÅúÊ≠¢ÂºπÂá∫Èü≥‰πêÊí≠ÊîæËøõÂ∫¶Êõ¥Êñ∞
        function stopPopupProgress() {
            if (progressUpdateInterval) {
                clearInterval(progressUpdateInterval);
                progressUpdateInterval = null;
            }
            if (popupAudioPlayer) {
                popupAudioPlayer.pause();
                popupAudioPlayer = null;
            }
            progressFill.style.width = '0%';
            currentTimeSpan.textContent = '00:00';
            popupPlayBtn.textContent = '‚ñ∂Ô∏è';
        }

        // Ê†ºÂºèÂåñÊó∂Èó¥
        function formatTime(seconds) {
            const mins = Math.floor(seconds / 60);
            const secs = seconds % 60;
            return `${mins.toString().padStart(2, '0')}:${secs.toString().padStart(2, '0')}`;
        }

        // Êí≠ÊîæÂºπÂá∫Èü≥‰πêÂç°Áâá‰∏≠ÁöÑÈü≥‰πê
        function playPopupMusic(musicData, playImmediately = true) {
            if (!musicData.url) {
                alert('ËØ•Èü≥‰πêÊ≤°ÊúâÈü≥È¢ëÈìæÊé•');
                return;
            }

            // ÂÅúÊ≠¢ÂÖ®Â±ÄÊí≠ÊîæÂô®
            if (globalAudioPlayer) {
                globalAudioPlayer.pause();
                globalAudioPlayer.currentTime = 0;
            }

            // ÂàõÂª∫Êñ∞ÁöÑÂºπÂá∫Èü≥È¢ëÊí≠ÊîæÂô®
            popupAudioPlayer = new Audio(musicData.url);
            popupAudioPlayer.volume = 0.8;

            // Ê∑ªÂä†‰∫ã‰ª∂ÁõëÂê¨
            popupAudioPlayer.addEventListener('loadedmetadata', () => {
                totalTimeSpan.textContent = formatTime(Math.floor(popupAudioPlayer.duration));
            });

            popupAudioPlayer.addEventListener('play', () => {
                popupPlayBtn.textContent = '‚è∏Ô∏è';
                popupPlayBtn.title = 'ÊöÇÂÅúÊí≠Êîæ';
                startPopupProgress();
                albumArt.style.animationPlayState = 'running';
            });

            popupAudioPlayer.addEventListener('pause', () => {
                popupPlayBtn.textContent = '‚ñ∂Ô∏è';
                popupPlayBtn.title = 'Êí≠ÊîæÈü≥‰πê';
                stopPopupProgress();
                albumArt.style.animationPlayState = 'paused';
            });

            popupAudioPlayer.addEventListener('ended', () => {
                popupPlayBtn.textContent = '‚ñ∂Ô∏è';
                popupPlayBtn.title = 'Êí≠ÊîæÈü≥‰πê';
                stopPopupProgress();
                albumArt.style.animationPlayState = 'paused';
            });

            // Êí≠ÊîæÈü≥‰πê
            if (playImmediately) {
                popupAudioPlayer.play().catch(error => {
                    console.error('Êí≠ÊîæÂ§±Ë¥•:', error);
                    alert('Êí≠ÊîæÂ§±Ë¥•ÔºåËØ∑Ê£ÄÊü•Èü≥È¢ëÈìæÊé•');
                });
            }
        }

        // ÂºπÂá∫Èü≥‰πêÂç°ÁâáÊéßÂà∂‰∫ã‰ª∂
        closePopupBtn.addEventListener('click', hidePopupMusicCard);
        musicOverlay.addEventListener('click', hidePopupMusicCard);

        // QQÈü≥‰πêÊåâÈíÆ
        qqMusicBtn.addEventListener('click', openQQMusicPlayer);

        // ÈöèÊú∫Èü≥‰πêÊåâÈíÆ
        randomBtn.addEventListener('click', async () => {
            try {
                const response = await fetch('/api/music/random');
                const result = await response.json();
                
                if (result.success) {
                    const music = result.data;
                    showPopupMusicCard(music);
                    updatePopupMusicCard(music);
                    
                    // ÂêåÊó∂ÂèëÈÄÅÂà∞ËÅäÂ§©
                    const message = `ÂàÜ‰∫´‰∏ÄÈ¶ñÂ•ΩÂê¨ÁöÑÈü≥‰πêÔºöüéµ ${music.name} - ${music.singer}`;
                    socket.emit('send_message', {
                        nickname: nickname,
                        message: message,
                        message_type: 'music',
                        is_music: true,
                        music_data: JSON.stringify(music)
                    });
                } else {
                    alert('Ëé∑ÂèñÈü≥‰πêÂ§±Ë¥•Ôºö' + (result.error || 'Êú™Áü•ÈîôËØØ'));
                }
            } catch (error) {
                console.error('Ëé∑ÂèñÈü≥‰πêÂ§±Ë¥•:', error);
                alert('Ëé∑ÂèñÈü≥‰πêÊó∂ÂèëÁîüÁΩëÁªúÈîôËØØ');
            }
        });

        // ÂºπÂá∫Êí≠ÊîæÊåâÈíÆ
        popupPlayBtn.addEventListener('click', () => {
            if (!popupCurrentMusic) return;

            if (!popupAudioPlayer || popupAudioPlayer.paused) {
                playPopupMusic(popupCurrentMusic, true);
            } else {
                popupAudioPlayer.pause();
            }
        });

        // ËøõÂ∫¶Êù°ÁÇπÂáª‰∫ã‰ª∂
        progressBar.addEventListener('click', (e) => {
            if (!popupAudioPlayer || !popupCurrentMusic) return;

            const rect = progressBar.getBoundingClientRect();
            const clickX = e.clientX - rect.left;
            const progressWidth = rect.width;
            const progress = clickX / progressWidth;
            
            if (popupAudioPlayer.duration) {
                popupAudioPlayer.currentTime = popupAudioPlayer.duration * progress;
            }
        });

        // ‰øÆÊîπÈü≥‰πêÊåâÈíÆÁÇπÂáª‰∫ã‰ª∂ - ÊòæÁ§∫ÂºπÂá∫Âç°Áâá
        musicBtn.addEventListener('click', () => {
            showPopupMusicCard();
        });

        // ÁõëÂê¨Ê∂àÊÅØËæìÂÖ•Ê°Ü‰∏≠ÁöÑ@Èü≥‰πê
        messageInput.addEventListener('input', () => {
            const message = messageInput.value;
            if (message.includes('@Èü≥‰πê') || message.includes('@Èü≥‰πê ')) {
                showPopupMusicCard();
            }
        });

        // ‰øÆÊîπÁé∞ÊúâgetRandomMusicÂáΩÊï∞‰ª•‰ΩøÁî®ÂºπÂá∫Âç°Áâá
        const originalGetRandomMusic = getRandomMusic;
        getRandomMusic = async function() {
            try {
                const response = await fetch('/api/music/random');
                const result = await response.json();
                
                if (result.success) {
                    const music = result.data;
                    
                    // ÊòæÁ§∫ÂºπÂá∫Èü≥‰πêÂç°Áâá
                    showPopupMusicCard(music);
                    updatePopupMusicCard(music);
                    
                    const message = `ÂàÜ‰∫´‰∏ÄÈ¶ñÂ•ΩÂê¨ÁöÑÈü≥‰πêÔºöüéµ ${music.name} - ${music.singer}`;
                    
                    socket.emit('send_message', {
                        nickname: nickname,
                        message: message,
                        message_type: 'music',
                        is_music: true,
                        music_data: JSON.stringify(music)
                    });
                } else {
                    alert('Ëé∑ÂèñÈü≥‰πêÂ§±Ë¥•Ôºö' + (result.error || 'Êú™Áü•ÈîôËØØ'));
                }
            } catch (error) {
                console.error('Ëé∑ÂèñÈü≥‰πêÂ§±Ë¥•:', error);
                alert('Ëé∑ÂèñÈü≥‰πêÊó∂ÂèëÁîüÁΩëÁªúÈîôËØØ');
            }
        };
        
        // Ëé∑ÂèñÂ§©Ê∞î‰ø°ÊÅØ
        async function getWeatherInfo() {
            try {
                // Â∞ùËØïËé∑ÂèñÊµèËßàÂô®Âú∞ÁêÜ‰ΩçÁΩÆÔºåÂ¶ÇÊûúÂ§±Ë¥•Âàô‰ΩøÁî®IPÂÆö‰Ωç
                const position = await getCurrentLocation();
                if (position) {
                    console.log('ÈÄöËøáÊµèËßàÂô®Ëé∑ÂèñÂà∞‰ΩçÁΩÆ:', position);
                    await fetchWeatherByCurrentLocation();
                } else {
                    console.log('ÊµèËßàÂô®ÂÆö‰ΩçÂ§±Ë¥•Ôºå‰ΩøÁî®IPÂÆö‰Ωç');
                    await fetchWeatherByCurrentLocation();
                }
            } catch (error) {
                console.error('Ëé∑ÂèñÂ§©Ê∞îÂ§±Ë¥•:', error);
                alert('Ëé∑ÂèñÂ§©Ê∞îÊó∂ÂèëÁîüÈîôËØØ');
            }
        }
        
        // Ëé∑ÂèñÊµèËßàÂô®Âú∞ÁêÜ‰ΩçÁΩÆ
        async function getCurrentLocation() {
            return new Promise((resolve) => {
                if (!navigator.geolocation) {
                    console.log('ÊµèËßàÂô®‰∏çÊîØÊåÅÂú∞ÁêÜ‰ΩçÁΩÆ');
                    resolve(null);
                    return;
                }
                
                const options = {
                    enableHighAccuracy: false,
                    timeout: 5000,
                    maximumAge: 300000
                };
                
                navigator.geolocation.getCurrentPosition(
                    (position) => {
                        resolve({
                            latitude: position.coords.latitude,
                            longitude: position.coords.longitude
                        });
                    },
                    (error) => {
                        console.log('Âú∞ÁêÜ‰ΩçÁΩÆËé∑ÂèñÂ§±Ë¥•:', error.message);
                        resolve(null);
                    },
                    options
                );
            });
        }
        
        // Ê†πÊçÆÂΩìÂâç‰ΩçÁΩÆËé∑ÂèñÂ§©Ê∞î
        async function fetchWeatherByCurrentLocation() {
            try {
                const response = await fetch('/api/weather/current-location');
                const result = await response.json();
                
                if (result.success) {
                    const weather = result.data;
                    const message = `üìç ÂΩìÂâçÂ§©Ê∞îÔºöüå§Ô∏è ${weather.city} ${weather.icon} ${weather.condition} ${weather.temperature}`;
                    
                    socket.emit('send_message', {
                        nickname: nickname,
                        message: message,
                        message_type: 'weather',
                        is_weather: true,
                        weather_data: JSON.stringify(weather)
                    });
                    
                    // Â∫îÁî®Â§©Ê∞î‰∏ªÈ¢ò
                    applyWeatherTheme(weather);
                    
                    // ÂπøÊí≠Â§©Ê∞îÊõ¥Êñ∞
                    socket.emit('weather_broadcast', {
                        weather_data: weather,
                        user: nickname
                    });
                } else {
                    alert('Ëé∑ÂèñÂΩìÂâç‰ΩçÁΩÆÂ§©Ê∞îÂ§±Ë¥•Ôºö' + (result.error || 'Êú™Áü•ÈîôËØØ'));
                }
            } catch (error) {
                console.error('Ëé∑ÂèñÂΩìÂâç‰ΩçÁΩÆÂ§©Ê∞îÂ§±Ë¥•:', error);
                alert('Ëé∑ÂèñÂΩìÂâç‰ΩçÁΩÆÂ§©Ê∞îÊó∂ÂèëÁîüÁΩëÁªúÈîôËØØ');
            }
        }
        
        // ÊòæÁ§∫ÂüéÂ∏ÇÊêúÁ¥¢ÂØπËØùÊ°Ü
        function showCitySearchDialog() {
            // ÂàõÂª∫Ê®°ÊÄÅÊ°Ü
            const modal = document.createElement('div');
            modal.className = 'city-search-modal';
            modal.innerHTML = `
                <div class="city-search-content">
                    <div class="city-search-header">
                        <h3>Êü•ËØ¢ÂüéÂ∏ÇÂ§©Ê∞î</h3>
                        <span class="close-btn">&times;</span>
                    </div>
                    <div class="city-search-body">
                        <input type="text" id="city-input" placeholder="ËØ∑ËæìÂÖ•ÂüéÂ∏ÇÂêçÁß∞ÔºàÂ¶ÇÔºöÂåó‰∫¨„ÄÅ‰∏äÊµ∑„ÄÅÊ∑±Âú≥Ôºâ" maxlength="20">
                        <div class="city-suggestions">
                            <div class="suggestion-title">ÁÉ≠Èó®ÂüéÂ∏ÇÔºö</div>
                            <div class="suggestion-cities">
                                <span class="city-suggestion" data-city="Âåó‰∫¨">Âåó‰∫¨</span>
                                <span class="city-suggestion" data-city="‰∏äÊµ∑">‰∏äÊµ∑</span>
                                <span class="city-suggestion" data-city="ÂπøÂ∑û">ÂπøÂ∑û</span>
                                <span class="city-suggestion" data-city="Ê∑±Âú≥">Ê∑±Âú≥</span>
                                <span class="city-suggestion" data-city="Êù≠Â∑û">Êù≠Â∑û</span>
                                <span class="city-suggestion" data-city="ÊàêÈÉΩ">ÊàêÈÉΩ</span>
                                <span class="city-suggestion" data-city="Âçó‰∫¨">Âçó‰∫¨</span>
                                <span class="city-suggestion" data-city="Ê≠¶Ê±â">Ê≠¶Ê±â</span>
                            </div>
                        </div>
                        <div class="city-search-actions">
                            <button id="search-city-btn" class="search-btn">Êü•ËØ¢Â§©Ê∞î</button>
                            <button id="current-location-btn" class="current-btn">ÂΩìÂâçÂüéÂ∏Ç</button>
                        </div>
                    </div>
                </div>
            `;
            
            // Ê∑ªÂä†Ê†∑Âºè
            const style = document.createElement('style');
            style.textContent = `
                .city-search-modal {
                    position: fixed;
                    top: 0;
                    left: 0;
                    width: 100%;
                    height: 100%;
                    background: rgba(0, 0, 0, 0.6);
                    display: flex;
                    justify-content: center;
                    align-items: center;
                    z-index: 10000;
                }
                .city-search-content {
                    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
                    border-radius: 15px;
                    padding: 0;
                    min-width: 400px;
                    max-width: 90vw;
                    box-shadow: 0 10px 30px rgba(0, 0, 0, 0.3);
                    animation: modalShow 0.3s ease-out;
                }
                @keyframes modalShow {
                    from { opacity: 0; transform: scale(0.8); }
                    to { opacity: 1; transform: scale(1); }
                }
                .city-search-header {
                    display: flex;
                    justify-content: space-between;
                    align-items: center;
                    padding: 20px 25px;
                    border-bottom: 1px solid rgba(255, 255, 255, 0.2);
                    color: white;
                }
                .city-search-header h3 {
                    margin: 0;
                    font-size: 18px;
                    font-weight: 600;
                }
                .close-btn {
                    cursor: pointer;
                    font-size: 24px;
                    font-weight: bold;
                    opacity: 0.8;
                    transition: opacity 0.2s;
                }
                .close-btn:hover {
                    opacity: 1;
                }
                .city-search-body {
                    padding: 25px;
                }
                #city-input {
                    width: 100%;
                    padding: 12px 15px;
                    border: 2px solid rgba(255, 255, 255, 0.3);
                    border-radius: 10px;
                    background: rgba(255, 255, 255, 0.9);
                    font-size: 16px;
                    margin-bottom: 15px;
                    box-sizing: border-box;
                    outline: none;
                    transition: border-color 0.2s;
                }
                #city-input:focus {
                    border-color: #4CAF50;
                }
                .city-suggestions {
                    margin-bottom: 20px;
                }
                .suggestion-title {
                    color: rgba(255, 255, 255, 0.9);
                    font-size: 14px;
                    margin-bottom: 8px;
                }
                .suggestion-cities {
                    display: flex;
                    flex-wrap: wrap;
                    gap: 8px;
                }
                .city-suggestion {
                    background: rgba(255, 255, 255, 0.2);
                    color: white;
                    padding: 6px 12px;
                    border-radius: 20px;
                    font-size: 12px;
                    cursor: pointer;
                    transition: all 0.2s;
                }
                .city-suggestion:hover {
                    background: rgba(255, 255, 255, 0.3);
                    transform: translateY(-1px);
                }
                .city-search-actions {
                    display: flex;
                    gap: 10px;
                }
                .search-btn, .current-btn {
                    flex: 1;
                    padding: 12px 20px;
                    border: none;
                    border-radius: 8px;
                    font-size: 14px;
                    font-weight: 600;
                    cursor: pointer;
                    transition: all 0.2s;
                }
                .search-btn {
                    background: linear-gradient(45deg, #4CAF50, #45a049);
                    color: white;
                }
                .search-btn:hover {
                    transform: translateY(-1px);
                    box-shadow: 0 4px 8px rgba(76, 175, 80, 0.3);
                }
                .current-btn {
                    background: linear-gradient(45deg, #2196F3, #1976D2);
                    color: white;
                }
                .current-btn:hover {
                    transform: translateY(-1px);
                    box-shadow: 0 4px 8px rgba(33, 150, 243, 0.3);
                }
            `;
            
            document.head.appendChild(style);
            document.body.appendChild(modal);
            
            // ‰∫ã‰ª∂ÁªëÂÆö
            const closeBtn = modal.querySelector('.close-btn');
            const cityInput = modal.querySelector('#city-input');
            const searchBtn = modal.querySelector('#search-city-btn');
            const currentBtn = modal.querySelector('#current-location-btn');
            const suggestions = modal.querySelectorAll('.city-suggestion');
            
            // ÂÖ≥Èó≠Ê®°ÊÄÅÊ°Ü
            const closeModal = () => {
                modal.remove();
                style.remove();
            };
            
            closeBtn.addEventListener('click', closeModal);
            modal.addEventListener('click', (e) => {
                if (e.target === modal) closeModal();
            });
            
            // ÁÉ≠Èó®ÂüéÂ∏ÇÁÇπÂáª
            suggestions.forEach(suggestion => {
                suggestion.addEventListener('click', () => {
                    cityInput.value = suggestion.getAttribute('data-city');
                });
            });
            
            // ÊêúÁ¥¢ÂüéÂ∏ÇÂ§©Ê∞î
            searchBtn.addEventListener('click', async () => {
                const city = cityInput.value.trim();
                if (!city) {
                    alert('ËØ∑ËæìÂÖ•ÂüéÂ∏ÇÂêçÁß∞');
                    return;
                }
                
                closeModal();
                await fetchWeatherByCity(city);
            });
            
            // Êü•ËØ¢ÂΩìÂâç‰ΩçÁΩÆÂ§©Ê∞î
            currentBtn.addEventListener('click', async () => {
                closeModal();
                await getWeatherInfo();
            });
            
            // ÂõûËΩ¶ÈîÆÊêúÁ¥¢
            cityInput.addEventListener('keypress', (e) => {
                if (e.key === 'Enter') {
                    searchBtn.click();
                }
            });
            
            // Ëá™Âä®ËÅöÁÑ¶ËæìÂÖ•Ê°Ü
            setTimeout(() => {
                cityInput.focus();
            }, 100);
        }
        
        // Â§©Ê∞î‰∏ªÈ¢òÈÖçÁΩÆ - Ê¢¶Âπª‰ΩéÈ•±ÂíåÂ∫¶Á≤âËìùËâ≤Á≥ª
        const weatherThemes = {
            'Êô¥': {
                name: 'sunny',
                bg: 'linear-gradient(135deg, rgba(255, 228, 225, 0.4) 0%, rgba(248, 248, 255, 0.3) 50%, rgba(240, 230, 140, 0.2) 100%)',
                sidebar: 'linear-gradient(180deg, rgba(255, 228, 225, 0.3), rgba(240, 248, 255, 0.3))',
                accent: 'rgba(255, 215, 0, 0.6)',
                shadow: 'rgba(255,215,0,0.2)'
            },
            'Êô¥Â§©': {
                name: 'sunny',
                bg: 'linear-gradient(135deg, rgba(255, 228, 225, 0.4) 0%, rgba(248, 248, 255, 0.3) 50%, rgba(240, 230, 140, 0.2) 100%)',
                sidebar: 'linear-gradient(180deg, rgba(255, 228, 225, 0.3), rgba(240, 248, 255, 0.3))',
                accent: 'rgba(255, 215, 0, 0.6)',
                shadow: 'rgba(255,215,0,0.2)'
            },
            'Â§ö‰∫ë': {
                name: 'cloudy',
                bg: 'linear-gradient(135deg, rgba(230, 230, 250, 0.4) 0%, rgba(211, 211, 211, 0.3) 50%, rgba(192, 192, 192, 0.2) 100%)',
                sidebar: 'linear-gradient(180deg, rgba(230, 230, 250, 0.3), rgba(211, 211, 211, 0.3))',
                accent: 'rgba(112, 128, 144, 0.5)',
                shadow: 'rgba(112,128,144,0.2)'
            },
            'Èò¥': {
                name: 'overcast',
                bg: 'linear-gradient(135deg, rgba(169, 169, 169, 0.3) 0%, rgba(105, 105, 105, 0.25) 50%, rgba(47, 79, 79, 0.2) 100%)',
                sidebar: 'linear-gradient(180deg, rgba(169, 169, 169, 0.25), rgba(105, 105, 105, 0.25))',
                accent: 'rgba(112, 128, 144, 0.5)',
                shadow: 'rgba(47,79,79,0.2)'
            },
            'Èò¥Â§©': {
                name: 'overcast',
                bg: 'linear-gradient(135deg, rgba(169, 169, 169, 0.3) 0%, rgba(105, 105, 105, 0.25) 50%, rgba(47, 79, 79, 0.2) 100%)',
                sidebar: 'linear-gradient(180deg, rgba(169, 169, 169, 0.25), rgba(105, 105, 105, 0.25))',
                accent: 'rgba(112, 128, 144, 0.5)',
                shadow: 'rgba(47,79,79,0.2)'
            },
            'Èõ®': {
                name: 'rainy',
                bg: 'linear-gradient(135deg, rgba(255, 182, 193, 0.3) 0%, rgba(135, 206, 235, 0.25) 50%, rgba(25, 118, 210, 0.15) 100%)',
                sidebar: 'linear-gradient(180deg, rgba(255, 182, 193, 0.25), rgba(135, 206, 235, 0.25))',
                accent: 'rgba(135, 206, 235, 0.6)',
                shadow: 'rgba(30,144,255,0.2)'
            },
            'Èõ®Â§©': {
                name: 'rainy',
                bg: 'linear-gradient(135deg, rgba(255, 182, 193, 0.3) 0%, rgba(135, 206, 235, 0.25) 50%, rgba(25, 118, 210, 0.15) 100%)',
                sidebar: 'linear-gradient(180deg, rgba(255, 182, 193, 0.25), rgba(135, 206, 235, 0.25))',
                accent: 'rgba(135, 206, 235, 0.6)',
                shadow: 'rgba(30,144,255,0.2)'
            },
            'Â∞èÈõ®': {
                name: 'rainy',
                bg: 'linear-gradient(135deg, rgba(255, 182, 193, 0.3) 0%, rgba(135, 206, 235, 0.25) 50%, rgba(25, 118, 210, 0.15) 100%)',
                sidebar: 'linear-gradient(180deg, rgba(255, 182, 193, 0.25), rgba(135, 206, 235, 0.25))',
                accent: 'rgba(135, 206, 235, 0.6)',
                shadow: 'rgba(30,144,255,0.2)'
            },
            'Â§ßÈõ®': {
                name: 'rainy',
                bg: 'linear-gradient(135deg, rgba(255, 182, 193, 0.3) 0%, rgba(135, 206, 235, 0.25) 50%, rgba(25, 118, 210, 0.15) 100%)',
                sidebar: 'linear-gradient(180deg, rgba(255, 182, 193, 0.25), rgba(135, 206, 235, 0.25))',
                accent: 'rgba(135, 206, 235, 0.6)',
                shadow: 'rgba(30,144,255,0.2)'
            },
            'Èõ™': {
                name: 'snowy',
                bg: 'linear-gradient(135deg, rgba(255, 250, 250, 0.4) 0%, rgba(240, 248, 255, 0.35) 50%, rgba(230, 230, 250, 0.25) 100%)',
                sidebar: 'linear-gradient(180deg, rgba(255, 250, 250, 0.35), rgba(240, 248, 255, 0.35))',
                accent: 'rgba(255, 250, 250, 0.8)',
                shadow: 'rgba(255,255,255,0.2)'
            },
            'Èõ™Â§©': {
                name: 'snowy',
                bg: 'linear-gradient(135deg, rgba(255, 250, 250, 0.4) 0%, rgba(240, 248, 255, 0.35) 50%, rgba(230, 230, 250, 0.25) 100%)',
                sidebar: 'linear-gradient(180deg, rgba(255, 250, 250, 0.35), rgba(240, 248, 255, 0.35))',
                accent: 'rgba(255, 250, 250, 0.8)',
                shadow: 'rgba(255,255,255,0.2)'
            },
            'Èõæ': {
                name: 'foggy',
                bg: 'linear-gradient(135deg, rgba(245, 245, 245, 0.35) 0%, rgba(220, 220, 220, 0.3) 50%, rgba(169, 169, 169, 0.2) 100%)',
                sidebar: 'linear-gradient(180deg, rgba(245, 245, 245, 0.3), rgba(220, 220, 220, 0.3))',
                accent: 'rgba(105, 105, 105, 0.5)',
                shadow: 'rgba(105,105,105,0.2)'
            },
            'default': {
                name: 'cloudy',
                bg: 'linear-gradient(135deg, rgba(245, 247, 250, 0.4) 0%, rgba(195, 207, 226, 0.3) 100%)',
                sidebar: 'linear-gradient(180deg, rgba(255, 228, 225, 0.3), rgba(224, 246, 255, 0.3))',
                accent: 'rgba(118, 75, 162, 0.5)',
                shadow: 'rgba(118,75,162,0.2)'
            }
        };

        // Ê†πÊçÆÂüéÂ∏ÇËé∑ÂèñÂ§©Ê∞î
        async function fetchWeatherByCity(city) {
            try {
                const response = await fetch(`/api/weather/info?city=${encodeURIComponent(city)}`);
                const result = await response.json();
                
                if (result.success) {
                    const weather = result.data;
                    const message = `‰ªäÊó•Â§©Ê∞îÔºöüå§Ô∏è ${weather.city} ${weather.icon} ${weather.condition} ${weather.temperature}`;
                    
                    socket.emit('send_message', {
                        nickname: nickname,
                        message: message,
                        message_type: 'weather',
                        is_weather: true,
                        weather_data: JSON.stringify(weather)
                    });
                    
                    // Â∫îÁî®Â§©Ê∞î‰∏ªÈ¢ò
                    applyWeatherTheme(weather);
                    
                    // ÂπøÊí≠Â§©Ê∞îÊõ¥Êñ∞
                    socket.emit('weather_broadcast', {
                        weather_data: weather,
                        user: nickname
                    });
                } else {
                    alert('Ëé∑ÂèñÂ§©Ê∞îÂ§±Ë¥•Ôºö' + (result.error || 'Êú™Áü•ÈîôËØØ'));
                }
            } catch (error) {
                console.error('Ëé∑ÂèñÂ§©Ê∞îÂ§±Ë¥•:', error);
                alert('Ëé∑ÂèñÂ§©Ê∞îÊó∂ÂèëÁîüÁΩëÁªúÈîôËØØ');
            }
        }
        
        // Â∫îÁî®Â§©Ê∞î‰∏ªÈ¢ò
        function applyWeatherTheme(weatherData) {
            const condition = weatherData.condition || 'Êô¥';
            const temperature = parseFloat(weatherData.temperature) || 20;
            const theme = weatherThemes[condition] || weatherThemes.default;
            
            // Ê†πÊçÆÊ∏©Â∫¶Ë∞ÉÊï¥‰∏ªÈ¢òÈ¢úËâ≤
            const temperatureAdjustedTheme = adjustThemeByTemperature(theme, temperature);
            
            // Â∫îÁî®‰∏ªÈ¢òÂà∞È°µÈù¢
            document.body.style.background = temperatureAdjustedTheme.bg;
            document.body.style.transition = 'background 0.5s ease';
            
            // Êõ¥Êñ∞‰æßËæπÊ†è
            const sidebar = document.querySelector('.sidebar');
            if (sidebar) {
                sidebar.style.background = temperatureAdjustedTheme.sidebar;
                sidebar.style.transition = 'background 0.5s ease';
            }
            
            // Êõ¥Êñ∞ËÅäÂ§©Â§¥ÈÉ®
            const chatHeader = document.querySelector('.chat-header');
            if (chatHeader) {
                chatHeader.style.background = `linear-gradient(45deg, ${temperatureAdjustedTheme.accent}20, ${temperatureAdjustedTheme.accent}10)`;
                chatHeader.style.boxShadow = `0 2px 10px ${temperatureAdjustedTheme.shadow}`;
            }
            
            // Êõ¥Êñ∞Ê∂àÊÅØÂÆπÂô®ËÉåÊôØÔºàÊ†πÊçÆÊ∏©Â∫¶ÂèòÂåñÔºâ- ÁôªÂΩïÁïåÈù¢ËìùÁ≤âÈÖçËâ≤ÁâàÊú¨
            const messagesContainer = document.getElementById('messages-container');
            if (messagesContainer) {
                // ÂàõÂª∫Ê∂àÊÅØÂÆπÂô®ÁöÑÊ∏©Â∫¶ÂìçÂ∫îËÉåÊôØ - ÁôªÂΩïÁïåÈù¢ÈÖçËâ≤ÁâàÊú¨
                let messageBg;
                
                if (temperature <= -15) {
                    // ‚â§-15¬∞C - ÊûÅÂØíÔºöÊ∑±Â§©ËìùËâ≤Ë∞É
                    messageBg = 'rgba(13, 71, 161, 0.85)';
                } else if (temperature <= -10) {
                    // -15Âà∞-10¬∞C - ‰∏•ÂØíÔºö‰∏≠Ê∑±Â§©ËìùËâ≤Ë∞É
                    messageBg = 'rgba(21, 101, 192, 0.82)';
                } else if (temperature <= -5) {
                    // -10Âà∞-5¬∞C - ÂØíÂÜ∑ÔºöÊµÖÂ§©ËìùËâ≤Ë∞É
                    messageBg = 'rgba(25, 118, 210, 0.8)';
                } else if (temperature <= 0) {
                    // -5Âà∞0¬∞C - ÂáâÁàΩÔºöÂ§©ËìùËâ≤Ë∞É
                    messageBg = 'rgba(30, 136, 229, 0.78)';
                } else if (temperature <= 5) {
                    // 0Âà∞5¬∞C - ÂæÆÂÜ∑ÔºöÊµÖÂ§©ËìùËâ≤Ë∞É
                    messageBg = 'rgba(33, 150, 243, 0.8)';
                } else if (temperature <= 10) {
                    // 5Âà∞10¬∞C - ËàíÈÄÇÔºöÊ∑°ËìùËâ≤Ë∞É
                    messageBg = 'rgba(66, 165, 245, 0.82)';
                } else if (temperature <= 15) {
                    // 10Âà∞15¬∞C - Ê∏©ÊöñÔºöÊµÖÁ≤âËìùËâ≤Ë∞ÉÔºàËøáÊ∏°Ëâ≤Ôºâ
                    messageBg = 'rgba(255, 154, 158, 0.85)';
                } else if (temperature <= 20) {
                    // 15Âà∞20¬∞C - ÈÄÇ‰∏≠ÔºöÊµÖÁ≤âËâ≤Ë∞É
                    messageBg = 'rgba(254, 207, 239, 0.83)';
                } else if (temperature <= 25) {
                    // 20Âà∞25¬∞C - ËàíÈÄÇÔºö‰∏≠ÊµÖÁ≤âËâ≤Ë∞É
                    messageBg = 'rgba(255, 182, 193, 0.8)';
                } else if (temperature <= 30) {
                    // 25Âà∞30¬∞C - ÁÇéÁÉ≠Ôºö‰∏≠Á≤âËâ≤Ë∞É
                    messageBg = 'rgba(255, 105, 180, 0.85)';
                } else {
                    // >30¬∞C - ÈÖ∑ÁÉ≠ÔºöÊ∑±ÁÉ≠Á≤âËâ≤Ë∞É
                    messageBg = 'rgba(255, 20, 147, 0.82)';
                }
                
                messagesContainer.style.background = messageBg;
                messagesContainer.style.backdropFilter = 'blur(15px)';
                messagesContainer.style.borderColor = temperatureAdjustedTheme.accent + '30';
                messagesContainer.style.boxShadow = `0 4px 20px ${temperatureAdjustedTheme.shadow}`;
                messagesContainer.style.transition = 'all 0.5s ease';
                
                console.log(`Ê∏©Â∫¶ ${temperature}¬∞C ÁôªÂΩïÁïåÈù¢ÈÖçËâ≤Ê∂àÊÅØÂÆπÂô®ËÉåÊôØ:`, messageBg);
            }
            
            // Ê∑ªÂä†Â§©Ê∞î‰∏ªÈ¢òÊ†áËØÜ
            document.body.setAttribute('data-weather-theme', theme.name);
            
            // ÊòæÁ§∫Ê∏©Â∫¶ÊèêÁ§∫
            showTemperatureFeedback(temperature, condition);
            
            // ÂàõÂª∫Â§©Ê∞îËÉåÊôØÁâπÊïà
            createWeatherEffect(theme.name, weatherData);
        }
        
        // Ê†πÊçÆÊ∏©Â∫¶Ë∞ÉÊï¥‰∏ªÈ¢òÈ¢úËâ≤ - ÁôªÂΩïÁïåÈù¢ËìùÁ≤âÈÖçËâ≤ÊñπÊ°à
        function adjustThemeByTemperature(baseTheme, temperature) {
            const adjustedTheme = {...baseTheme};
            
            // Ê∏©Â∫¶ËåÉÂõ¥Êò†Â∞Ñ - ÁôªÂΩïÁïåÈù¢ÈÖçËâ≤ÊñπÊ°à
            if (temperature <= -15) {
                // ‚â§-15¬∞C - ÊûÅÂØíÔºöÊ∑±Â§©ËìùËâ≤Ë∞ÉÔºàË∂äÂÜ∑Ë∂äÊ∑±Ôºâ
                adjustedTheme.bg = 'linear-gradient(135deg, #0d47a1 0%, #1565c0 50%, #1976d2 100%)';
                adjustedTheme.sidebar = 'linear-gradient(180deg, #0d47a1, #1565c0)';
                adjustedTheme.accent = '#E0F6FF';
                adjustedTheme.shadow = 'rgba(13, 71, 161, 0.4)';
            } else if (temperature <= -10) {
                // -15Âà∞-10¬∞C - ‰∏•ÂØíÔºö‰∏≠Ê∑±Â§©ËìùËâ≤Ë∞É
                adjustedTheme.bg = 'linear-gradient(135deg, #1565c0 0%, #1976d2 50%, #1e88e5 100%)';
                adjustedTheme.sidebar = 'linear-gradient(180deg, #1565c0, #1976d2)';
                adjustedTheme.accent = '#B0E0E6';
                adjustedTheme.shadow = 'rgba(21, 101, 192, 0.4)';
            } else if (temperature <= -5) {
                // -10Âà∞-5¬∞C - ÂØíÂÜ∑ÔºöÊµÖÂ§©ËìùËâ≤Ë∞É
                adjustedTheme.bg = 'linear-gradient(135deg, #1976d2 0%, #1e88e5 50%, #2196f3 100%)';
                adjustedTheme.sidebar = 'linear-gradient(180deg, #1976d2, #1e88e5)';
                adjustedTheme.accent = '#ADD8E6';
                adjustedTheme.shadow = 'rgba(25, 118, 210, 0.4)';
            } else if (temperature <= 0) {
                // -5Âà∞0¬∞C - ÂáâÁàΩÔºöÂ§©ËìùËâ≤Ë∞É
                adjustedTheme.bg = 'linear-gradient(135deg, #1e88e5 0%, #2196f3 50%, #42a5f5 100%)';
                adjustedTheme.sidebar = 'linear-gradient(180deg, #1e88e5, #2196f3)';
                adjustedTheme.accent = '#87CEEB';
                adjustedTheme.shadow = 'rgba(30, 136, 229, 0.4)';
            } else if (temperature <= 5) {
                // 0Âà∞5¬∞C - ÂæÆÂÜ∑ÔºöÊµÖÂ§©ËìùËâ≤Ë∞É
                adjustedTheme.bg = 'linear-gradient(135deg, #2196f3 0%, #42a5f5 50%, #64b5f6 100%)';
                adjustedTheme.sidebar = 'linear-gradient(180deg, #2196f3, #42a5f5)';
                adjustedTheme.accent = '#B0E0E6';
                adjustedTheme.shadow = 'rgba(33, 150, 243, 0.4)';
            } else if (temperature <= 10) {
                // 5Âà∞10¬∞C - ËàíÈÄÇÔºöÊ∑°ËìùËâ≤Ë∞É
                adjustedTheme.bg = 'linear-gradient(135deg, #42a5f5 0%, #64b5f6 50%, #90caf9 100%)';
                adjustedTheme.sidebar = 'linear-gradient(180deg, #42a5f5, #64b5f6)';
                adjustedTheme.accent = '#E0F6FF';
                adjustedTheme.shadow = 'rgba(66, 165, 245, 0.4)';
            } else if (temperature <= 15) {
                // 10Âà∞15¬∞C - Ê∏©ÊöñÔºöÊµÖÁ≤âËìùËâ≤Ë∞ÉÔºàËøáÊ∏°Ëâ≤Ôºâ
                adjustedTheme.bg = 'linear-gradient(135deg, #ff9a9e 0%, #fecfef 50%, #ffeef5 100%)';
                adjustedTheme.sidebar = 'linear-gradient(180deg, #ff9a9e, #fecfef)';
                adjustedTheme.accent = '#fff';
                adjustedTheme.shadow = 'rgba(255, 154, 158, 0.4)';
            } else if (temperature <= 20) {
                // 15Âà∞20¬∞C - ÈÄÇ‰∏≠ÔºöÊµÖÁ≤âËâ≤Ë∞É
                adjustedTheme.bg = 'linear-gradient(135deg, #fecfef 0%, #ffeef5 50%, #fff0f5 100%)';
                adjustedTheme.sidebar = 'linear-gradient(180deg, #fecfef, #ffeef5)';
                adjustedTheme.accent = '#fff';
                adjustedTheme.shadow = 'rgba(254, 207, 239, 0.4)';
            } else if (temperature <= 25) {
                // 20Âà∞25¬∞C - ËàíÈÄÇÔºö‰∏≠ÊµÖÁ≤âËâ≤Ë∞ÉÔºàË∂äÁÉ≠Ë∂äÊ∑±Ôºâ
                adjustedTheme.bg = 'linear-gradient(135deg, #FFB6C1 0%, #ffc0cb 50%, #ffd1dc 100%)';
                adjustedTheme.sidebar = 'linear-gradient(180deg, #FFB6C1, #ffc0cb)';
                adjustedTheme.accent = '#fff';
                adjustedTheme.shadow = 'rgba(255, 182, 193, 0.4)';
            } else if (temperature <= 30) {
                // 25Âà∞30¬∞C - ÁÇéÁÉ≠Ôºö‰∏≠Á≤âËâ≤Ë∞É
                adjustedTheme.bg = 'linear-gradient(135deg, #ff69b4 0%, #ff1493 50%, #dc143c 100%)';
                adjustedTheme.sidebar = 'linear-gradient(180deg, #ff69b4, #ff1493)';
                adjustedTheme.accent = '#fff';
                adjustedTheme.shadow = 'rgba(255, 105, 180, 0.4)';
            } else {
                // >30¬∞C - ÈÖ∑ÁÉ≠ÔºöÊ∑±ÁÉ≠Á≤âËâ≤Ë∞É
                adjustedTheme.bg = 'linear-gradient(135deg, #ff1493 0%, #dc143c 50%, #b71c1c 100%)';
                adjustedTheme.sidebar = 'linear-gradient(180deg, #ff1493, #dc143c)';
                adjustedTheme.accent = '#fff';
                adjustedTheme.shadow = 'rgba(255, 20, 147, 0.4)';
            }
            
            // Âº∫Âà∂Âà∑Êñ∞ËÉåÊôØ
            document.body.style.transition = 'none';
            document.body.style.background = adjustedTheme.bg;
            document.body.style.transition = 'background 0.8s ease';
            
            console.log(`Ê∏©Â∫¶ ${temperature}¬∞C Â∫îÁî®ÁôªÂΩïÁïåÈù¢ÈÖçËâ≤‰∏ªÈ¢ò:`, adjustedTheme.bg);
            
            return adjustedTheme;
        }
        
        // ÊòæÁ§∫Ê∏©Â∫¶ÂèçÈ¶à
        function showTemperatureFeedback(temperature, condition) {
            // ÁßªÈô§‰πãÂâçÁöÑÊ∏©Â∫¶ÊèêÁ§∫
            const existingFeedback = document.querySelector('.temperature-feedback');
            if (existingFeedback) {
                existingFeedback.remove();
            }
            
            const feedback = document.createElement('div');
            feedback.className = 'temperature-feedback';
            
            // Ê†πÊçÆÊ∏©Â∫¶ËÆæÁΩÆÊèêÁ§∫ÊñáÊú¨ÂíåÈ¢úËâ≤ - ÁôªÂΩïÁïåÈù¢ËìùÁ≤âÈÖçËâ≤ÊñπÊ°à
            let text, bgColor, textColor;
            if (temperature <= -15) {
                text = `üå®Ô∏è ÊûÅÂØí ${temperature}¬∞C`;
                bgColor = 'rgba(13, 71, 161, 0.95)';
                textColor = 'white';
            } else if (temperature <= -5) {
                text = `ü•∂ ‰∏•ÂØí ${temperature}¬∞C`;
                bgColor = 'rgba(21, 101, 192, 0.93)';
                textColor = 'white';
            } else if (temperature <= 5) {
                text = `‚ùÑÔ∏è ÂØíÂÜ∑ ${temperature}¬∞C`;
                bgColor = 'rgba(25, 118, 210, 0.92)';
                textColor = 'white';
            } else if (temperature <= 15) {
                text = `üå°Ô∏è ÂáâÁàΩ ${temperature}¬∞C`;
                bgColor = 'rgba(30, 136, 229, 0.9)';
                textColor = 'white';
            } else if (temperature <= 25) {
                text = `üå§Ô∏è ËàíÈÄÇ ${temperature}¬∞C`;
                bgColor = 'rgba(255, 154, 158, 0.95)';
                textColor = 'white';
            } else {
                text = `‚òÄÔ∏è ÁÇéÁÉ≠ ${temperature}¬∞C`;
                bgColor = 'rgba(255, 105, 180, 0.93)';
                textColor = 'white';
            }
            
            feedback.innerHTML = text;
            feedback.style.cssText = `
                position: fixed;
                top: 80px;
                right: 20px;
                padding: 10px 18px;
                border-radius: 25px;
                background: ${bgColor};
                color: ${textColor};
                font-size: 14px;
                font-weight: bold;
                z-index: 1000;
                animation: temperature-pulse 0.5s ease-out;
                box-shadow: 0 4px 12px rgba(0,0,0,0.2);
                transition: all 0.3s ease;
                backdrop-filter: blur(10px);
                border: 1px solid rgba(255,255,255,0.2);
                max-width: 150px;
                text-align: center;
            `;
            
            document.body.appendChild(feedback);
            
            // 3ÁßíÂêéËá™Âä®Ê∂àÂ§±
            setTimeout(() => {
                if (feedback.parentNode) {
                    feedback.style.opacity = '0';
                    setTimeout(() => {
                        if (feedback.parentNode) {
                            feedback.remove();
                        }
                    }, 300);
                }
            }, 3000);
        }
        
        // Ê∑ªÂä†Ê∏©Â∫¶ÂèçÈ¶àÂä®ÁîªCSS
        if (!document.getElementById('temperature-style')) {
            const style = document.createElement('style');
            style.id = 'temperature-style';
            style.textContent = `
                @keyframes temperature-pulse {
                    0% { transform: scale(0.8) translateY(-10px); opacity: 0; }
                    50% { transform: scale(1.1); }
                    100% { transform: scale(1) translateY(0); opacity: 1; }
                }
            `;
            document.head.appendChild(style);
        }
        
        // ÂàõÂª∫Â§©Ê∞îÁâπÊïà - Ê¢¶ÂπªÁ≤âËìùËâ≤ÊåÅÁª≠Âä®ÊïàÁâàÊú¨
        function createWeatherEffect(themeName, weatherData) {
            // ÁßªÈô§‰πãÂâçÁöÑÁâπÊïà
            const existingEffect = document.querySelector('.weather-background-effect');
            if (existingEffect) {
                existingEffect.remove();
            }
            
            const effect = document.createElement('div');
            effect.className = 'weather-background-effect';
            effect.style.cssText = `
                position: fixed;
                top: 0;
                left: 0;
                width: 100%;
                height: 100%;
                pointer-events: none;
                z-index: -1;
                opacity: 0.6;
                transition: opacity 0.5s ease;
            `;
            
            // Ê†πÊçÆÂ§©Ê∞îÁ±ªÂûãÂàõÂª∫ÁâπÊïà - Ê¢¶ÂπªÁ≤âËìùËâ≤ÊåÅÁª≠Âä®ÊïàÁâàÊú¨
            switch (themeName) {
                case 'rainy':
                    effect.innerHTML = createRainEffect();
                    break;
                case 'snowy':
                    effect.innerHTML = createSnowEffect();
                    break;
                case 'sunny':
                    effect.innerHTML = createSunEffect();
                    break;
                case 'cloudy':
                    effect.innerHTML = createCloudyEffect();
                    break;
                case 'foggy':
                    effect.innerHTML = createFoggyEffect();
                    break;
                default:
                    effect.innerHTML = createRainEffect(); // ÈªòËÆ§ÊòæÁ§∫Èõ®Êª¥ÊïàÊûú
            }
            
            document.body.appendChild(effect);
            
            // ÁâπÊïàÊåÅÁª≠ÊòæÁ§∫ÔºåÁõ¥Âà∞‰∏ãÊ¨°Â§©Ê∞îÂèòÂåñÊàñÊâãÂä®Ê∏ÖÈô§
            // ÁßªÈô§Ëá™Âä®Ê∂àÂ§±ÈÄªËæëÔºåËÆ©Âä®ÊïàÊåÅÁª≠
        }
        
        // Èõ®Êª¥ÁâπÊïà - Ê¢¶ÂπªÊ∑°ËìùÁ≤âÈÖçËâ≤ÊñπÊ°à
        function createRainEffect() {
            let html = '';
            // Â¢ûÂä†Èõ®Êª¥Êï∞ÈáèÔºåËê•ÈÄ†Êõ¥‰∏∞ÂØåÁöÑÊïàÊûú
            for (let i = 0; i < 80; i++) {
                const left = Math.random() * 100;
                const delay = Math.random() * 2;
                const duration = 1.0 + Math.random() * 1.0;
                // ‰ΩøÁî®Ê¢¶ÂπªÁöÑËìùÁ≤âÊ∏êÂèòËâ≤Èõ®Êª¥
                html += `<div class="rain-drop" style="
                    position: absolute;
                    left: ${left}%;
                    top: -10px;
                    width: 1.8px;
                    height: 30px;
                    background: linear-gradient(to bottom, 
                        rgba(255, 182, 193, 0.9), 
                        rgba(135, 206, 235, 0.7), 
                        rgba(25, 118, 210, 0.5)
                    );
                    animation: rain-fall ${duration}s ${delay}s infinite;
                    border-radius: 2px;
                    box-shadow: 0 0 4px rgba(255, 182, 193, 0.6);
                "></div>`;
            }
            
            // Ê∑ªÂä†Êõ¥‰∏∞ÂØåÁöÑÈõ®Êª¥Âä®ÁîªCSS - Ê¢¶ÂπªÁâàÊú¨
            if (!document.getElementById('weather-effect-styles')) {
                const style = document.createElement('style');
                style.id = 'weather-effect-styles';
                style.textContent = `
                    @keyframes rain-fall {
                        0% { transform: translateY(-20px) scale(0.8); opacity: 0; }
                        10% { opacity: 0.8; }
                        90% { opacity: 0.8; }
                        100% { transform: translateY(100vh) scale(1.2); opacity: 0; }
                    }
                    @keyframes snow-fall {
                        0% { transform: translateY(-20px) rotate(0deg) scale(0.8); opacity: 0; }
                        10% { opacity: 0.9; }
                        90% { opacity: 0.9; }
                        100% { transform: translateY(100vh) rotate(360deg) scale(1.1); opacity: 0; }
                    }
                    @keyframes sun-shine {
                        0%, 100% { opacity: 0.4; transform: scale(0.8) rotate(0deg); }
                        50% { opacity: 1; transform: scale(1.2) rotate(180deg); }
                    }
                    @keyframes cloud-float {
                        0% { transform: translateX(-10vw) scale(1) rotate(0deg); opacity: 0.4; }
                        50% { opacity: 0.8; transform: scale(1.05) rotate(2deg); }
                        100% { transform: translateX(110vw) scale(1.1) rotate(0deg); opacity: 0.4; }
                    }
                    @keyframes fog-move {
                        0% { transform: translateX(-20vw) scale(1) blur(0px); opacity: 0; }
                        50% { opacity: 0.7; transform: scale(1.1) blur(3px); }
                        100% { transform: translateX(120vw) scale(1.2) blur(0px); opacity: 0; }
                    }
                    @keyframes particle-float {
                        0% { transform: translateY(100vh) rotate(0deg); opacity: 0; }
                        10% { opacity: 0.8; }
                        90% { opacity: 0.8; }
                        100% { transform: translateY(-20vh) rotate(360deg); opacity: 0; }
                    }
                    @keyframes gradient-shift {
                        0% { background-position: 0% 50%; }
                        50% { background-position: 100% 50%; }
                        100% { background-position: 0% 50%; }
                    }
                    @keyframes sparkle {
                        0%, 100% { opacity: 0; transform: scale(0); }
                        50% { opacity: 1; transform: scale(1); }
                    }
                    @keyframes dreamy-shimmer {
                        0% { transform: translateX(-100%) skewX(-20deg); opacity: 0; }
                        50% { opacity: 0.6; }
                        100% { transform: translateX(200%) skewX(-20deg); opacity: 0; }
                    }
                `;
                document.head.appendChild(style);
            }
            
            return `<div style="position: relative; width: 100%; height: 100%; background: linear-gradient(135deg, rgba(255, 182, 193, 0.15), rgba(135, 206, 235, 0.12), rgba(25, 118, 210, 0.08)); background-size: 300% 300%; animation: gradient-shift 8s ease infinite;">${html}</div>`;
        }
        
        // Èõ™Ëä±ÁâπÊïà - Ê¢¶ÂπªÊ∑°ËìùÁ≤âÈÖçËâ≤ÊñπÊ°à
        function createSnowEffect() {
            let html = '';
            // Â¢ûÂä†Èõ™Ëä±Êï∞ÈáèÔºåËê•ÈÄ†Êõ¥Ê¢¶ÂπªÁöÑÊïàÊûú
            for (let i = 0; i < 50; i++) {
                const left = Math.random() * 100;
                const delay = Math.random() * 3;
                const duration = 2.0 + Math.random() * 2.5;
                const size = 2.5 + Math.random() * 4;
                // ‰ΩøÁî®Ê¢¶ÂπªÁöÑËìùÁ≤âÊ∏êÂèòËâ≤Èõ™Ëä±
                html += `<div class="snow-flake" style="
                    position: absolute;
                    left: ${left}%;
                    top: -10px;
                    width: ${size}px;
                    height: ${size}px;
                    background: radial-gradient(circle, 
                        rgba(255, 182, 193, 0.9), 
                        rgba(135, 206, 235, 0.8), 
                        rgba(25, 118, 210, 0.6)
                    );
                    border-radius: 50%;
                    animation: snow-fall ${duration}s ${delay}s infinite;
                    box-shadow: 0 0 6px rgba(255, 182, 193, 0.7);
                "></div>`;
            }
            
            // Ê∑ªÂä†Èó™ÁÉÅÁöÑÊòüÊòüÊïàÊûú
            for (let i = 0; i < 8; i++) {
                const left = Math.random() * 100;
                const top = Math.random() * 40 + 10;
                const delay = Math.random() * 4;
                const duration = 3 + Math.random() * 3;
                html += `<div class="sparkle" style="
                    position: absolute;
                    left: ${left}%;
                    top: ${top}%;
                    width: 3px;
                    height: 3px;
                    background: radial-gradient(circle, 
                        rgba(255, 105, 180, 1), 
                        rgba(255, 182, 193, 0.8)
                    );
                    border-radius: 50%;
                    animation: sparkle ${duration}s ${delay}s infinite;
                "></div>`;
            }
            
            return `<div style="position: relative; width: 100%; height: 100%; background: linear-gradient(135deg, rgba(255, 182, 193, 0.12), rgba(135, 206, 235, 0.10), rgba(25, 118, 210, 0.06)); background-size: 400% 400%; animation: gradient-shift 10s ease infinite;">${html}</div>`;
        }
        
        // Èò≥ÂÖâÁâπÊïà - Ê¢¶ÂπªÊ∑°ËìùÁ≤âÈÖçËâ≤ÊñπÊ°à
        function createSunEffect() {
            return `
                <!-- ‰∏ªÂ§™Èò≥ - Ê¢¶ÂπªÁ≤âËâ≤Ë∞É -->
                <div style="
                    position: absolute;
                    top: 20px;
                    right: 50px;
                    width: 120px;
                    height: 120px;
                    background: radial-gradient(circle, 
                        rgba(255, 182, 193, 0.9), 
                        rgba(255, 105, 180, 0.8),
                        rgba(135, 206, 235, 0.6)
                    );
                    border-radius: 50%;
                    animation: sun-shine 4s ease-in-out infinite;
                    box-shadow: 0 0 100px rgba(255, 182, 193, 0.6);
                "></div>
                <!-- ÂÜÖÂ±ÇÂ§™Èò≥ -->
                <div style="
                    position: absolute;
                    top: 45px;
                    right: 75px;
                    width: 70px;
                    height: 70px;
                    background: radial-gradient(circle, 
                        rgba(255, 192, 203, 0.8), 
                        rgba(255, 20, 147, 0.7),
                        transparent
                    );
                    border-radius: 50%;
                    animation: sun-shine 3s ease-in-out infinite reverse;
                "></div>
                <!-- Â§ñÂ±ÇÂÖâÊôï -->
                <div style="
                    position: absolute;
                    top: 5px;
                    right: 25px;
                    width: 150px;
                    height: 150px;
                    background: radial-gradient(circle, 
                        rgba(255, 182, 193, 0.4), 
                        rgba(135, 206, 235, 0.3),
                        transparent
                    );
                    border-radius: 50%;
                    animation: sun-shine 5s ease-in-out infinite;
                "></div>
                <!-- ÊµÆÂä®ÁöÑÂÖâÁÇπ -->
                <div style="
                    position: absolute;
                    top: 10px;
                    right: 20px;
                    width: 4px;
                    height: 4px;
                    background: radial-gradient(circle, rgba(255, 105, 180, 1), transparent);
                    border-radius: 50%;
                    animation: sparkle 2s ease-in-out infinite;
                "></div>
                <div style="
                    position: absolute;
                    top: 80px;
                    right: 140px;
                    width: 3px;
                    height: 3px;
                    background: radial-gradient(circle, rgba(255, 182, 193, 1), transparent);
                    border-radius: 50%;
                    animation: sparkle 2.5s ease-in-out infinite reverse;
                "></div>
                <div style="
                    position: absolute;
                    top: 60px;
                    right: 10px;
                    width: 2px;
                    height: 2px;
                    background: radial-gradient(circle, rgba(135, 206, 235, 1), transparent);
                    border-radius: 50%;
                    animation: sparkle 1.8s ease-in-out infinite;
                "></div>
            `;
        }
        
        // ‰∫ëÊúµÁâπÊïà - Ê¢¶ÂπªÊ∑°ËìùÁ≤âÈÖçËâ≤ÊñπÊ°à
        function createCloudyEffect() {
            let html = '';
            // Â¢ûÂä†‰∫ëÊúµÊï∞ÈáèÂíåÁßçÁ±ª
            for (let i = 0; i < 6; i++) {
                const top = Math.random() * 40 + 8;
                const left = Math.random() * 20 - 10;
                const delay = Math.random() * 5;
                const duration = 8 + Math.random() * 4;
                const scale = 0.7 + Math.random() * 0.7;
                
                html += `<div class="cloud" style="
                    position: absolute;
                    top: ${top}%;
                    left: ${left}%;
                    width: ${120 * scale}px;
                    height: ${60 * scale}px;
                    background: linear-gradient(135deg, 
                        rgba(255, 182, 193, 0.8), 
                        rgba(135, 206, 235, 0.7),
                        rgba(25, 118, 210, 0.5)
                    );
                    border-radius: 50px;
                    animation: cloud-float ${duration}s ${delay}s linear infinite;
                    box-shadow: 0 4px 12px rgba(255, 182, 193, 0.4);
                ">
                    <div style="
                        position: absolute;
                        top: -${20 * scale}px;
                        left: ${20 * scale}px;
                        width: ${60 * scale}px;
                        height: ${60 * scale}px;
                        background: linear-gradient(135deg, 
                            rgba(255, 182, 193, 0.8), 
                            rgba(135, 206, 235, 0.7),
                            rgba(25, 118, 210, 0.5)
                        );
                        border-radius: 50%;
                        animation: sparkle 4s ease-in-out infinite;
                    "></div>
                    <div style="
                        position: absolute;
                        top: -${30 * scale}px;
                        left: ${50 * scale}px;
                        width: ${80 * scale}px;
                        height: ${80 * scale}px;
                        background: linear-gradient(135deg, 
                            rgba(255, 182, 193, 0.8), 
                            rgba(135, 206, 235, 0.7),
                            rgba(25, 118, 210, 0.5)
                        );
                        border-radius: 50%;
                        animation: sparkle 3s ease-in-out infinite reverse;
                    "></div>
                    <div style="
                        position: absolute;
                        top: -${25 * scale}px;
                        left: ${90 * scale}px;
                        width: ${70 * scale}px;
                        height: ${70 * scale}px;
                        background: linear-gradient(135deg, 
                            rgba(255, 182, 193, 0.8), 
                            rgba(135, 206, 235, 0.7),
                            rgba(25, 118, 210, 0.5)
                        );
                        border-radius: 50%;
                        animation: sparkle 5s ease-in-out infinite;
                    "></div>
                </div>`;
            }
            
            // Ê∑ªÂä†Ê¢¶ÂπªÁöÑÂÖâÂ∏¶ÊïàÊûú
            html += `<div style="
                position: absolute;
                top: 30%;
                left: 0;
                width: 100%;
                height: 2px;
                background: linear-gradient(90deg, transparent, rgba(255, 182, 193, 0.6), rgba(135, 206, 235, 0.4), transparent);
                animation: dreamy-shimmer 12s ease-in-out infinite;
            "></div>`;
            
            return `<div style="position: relative; width: 100%; height: 100%; background: linear-gradient(135deg, rgba(255, 182, 193, 0.08), rgba(135, 206, 235, 0.06), rgba(25, 118, 210, 0.04)); background-size: 500% 500%; animation: gradient-shift 12s ease infinite;">${html}</div>`;
        }
        
        // ÈõæÂ§©ÁâπÊïà - ÁôªÂΩïÁïåÈù¢ËìùÁ≤âÈÖçËâ≤ÊñπÊ°à
        function createFoggyEffect() {
            let html = '';
            for (let i = 0; i < 3; i++) {
                const top = Math.random() * 60 + 10;
                const delay = Math.random() * 8;
                const duration = 10 + Math.random() * 5;
                
                html += `<div class="fog" style="
                    position: absolute;
                    top: ${top}%;
                    left: 0;
                    width: 200%;
                    height: 180px;
                    background: linear-gradient(
                        90deg,
                        transparent 0%,
                        rgba(255,154,158,0.2) 20%,
                        rgba(255,105,180,0.4) 50%,
                        rgba(255,154,158,0.2) 80%,
                        transparent 100%
                    );
                    animation: fog-move ${duration}s ${delay}s linear infinite;
                "></div>`;
            }
            
            // Ê∑ªÂä†ÊµÆÂä®Á≤íÂ≠êÊïàÊûú
            for (let i = 0; i < 20; i++) {
                const left = Math.random() * 100;
                const delay = Math.random() * 8;
                const duration = 6 + Math.random() * 6;
                const size = 2 + Math.random() * 4;
                html += `<div class="particle" style="
                    position: absolute;
                    left: ${left}%;
                    bottom: -10px;
                    width: ${size}px;
                    height: ${size}px;
                    background: rgba(255,154,158,0.6);
                    border-radius: 50%;
                    animation: particle-float ${duration}s ${delay}s linear infinite;
                "></div>`;
            }
            
            return `<div style="position: relative; width: 100%; height: 100%; background: linear-gradient(135deg, rgba(255,154,158,0.03), rgba(255,105,180,0.03)); background-size: 500% 500%; animation: gradient-shift 12s ease infinite;">${html}</div>`;
        }
        
        // ============= Êñ∞ÈóªÂäüËÉΩÁõ∏ÂÖ≥‰ª£Á†Å =============
        
        // Êñ∞ÈóªÊï∞ÊçÆÁªìÊûÑ
        let newsList = [];
        let currentNewsIndex = 0;
        let newsTimer = null;
        let newsPlaying = false;
        let newsStartTime = null;
        
        // Ê®°ÊãüÊñ∞ÈóªÊï∞ÊçÆÔºàÂÆûÈôÖÂ∫îÁî®‰∏≠Â∫îËØ•‰ªéAPIËé∑ÂèñÔºâ
        function generateMockNews() {
            const newsSources = [
                { name: "ÁßëÊäÄÊó•Êä•", category: "ÁßëÊäÄ" },
                { name: "Ë¥¢ÁªèËßÇÂØü", category: "Ë¥¢Áªè" },
                { name: "ÂÅ•Â∫∑Êó∂Êä•", category: "ÂÅ•Â∫∑" },
                { name: "‰ΩìËÇ≤Êñ∞Èóª", category: "‰ΩìËÇ≤" },
                { name: "Â®±‰πêÂë®Âàä", category: "Â®±‰πê" },
                { name: "ÂõΩÈôÖË¶ÅÈóª", category: "ÂõΩÈôÖ" }
            ];
            
            const newsTitles = [
                "AIÊäÄÊúØÈù©ÂëΩÔºö‰∫∫Â∑•Êô∫ËÉΩÊîπÂèòÁîüÊ¥ªÊñπÂºè",
                "ËÇ°Â∏ÇÂõûÊöñÔºöÊäïËµÑËÄÖ‰ø°ÂøÉÈÄêÊ≠•ÊÅ¢Â§ç",
                "ÂÅ•Â∫∑Êñ∞ÂèëÁé∞ÔºöËøêÂä®ÂØπÂ§ßËÑëÁöÑÁßØÊûÅÂΩ±Âìç",
                "‰ΩìËÇ≤Áõõ‰∫ãÔºöÂõΩÈôÖÊØîËµõÁ≤æÂΩ©Á∫∑Âëà",
                "ÂΩ±ËßÜÂúàÂä®ÊÄÅÔºöÊñ∞‰ΩúÂºïÂèëËßÇ‰ºóÁÉ≠ËÆÆ",
                "ÂÖ®ÁêÉÂêà‰ΩúÔºöÂõΩÈôÖÁªÑÁªáÊé®Âä®ÂíåÂπ≥ÂèëÂ±ï",
                "ÁéØ‰øùÊñ∞‰∏æÊé™ÔºöÁªøËâ≤ÁßëÊäÄÂä©ÂäõÂèØÊåÅÁª≠ÂèëÂ±ï",
                "ÊïôËÇ≤ÊîπÈù©ÔºöÊï∞Â≠óÂåñÂ≠¶‰π†Âπ≥Âè∞ÊôÆÂèä",
                "ÂåªÁñóÁ™ÅÁ†¥ÔºöÊñ∞ÂûãÊ≤ªÁñóÊñπÊ≥ïÂ∏¶Êù•Â∏åÊúõ",
                "ÂàõÊñ∞È©±Âä®ÔºöÂàõ‰∏öÂÖ¨Âè∏ÂºïÈ¢ÜË°å‰∏öÂèëÂ±ï"
            ];
            
            const newsContent = [
                "ÊúÄÊñ∞ÁöÑÁ†îÁ©∂Ë°®ÊòéÔºå‰∫∫Â∑•Êô∫ËÉΩÊäÄÊúØÊ≠£Âú®Ê∑±ÂàªÂú∞ÊîπÂèòÁùÄÊàë‰ª¨ÁöÑÊó•Â∏∏ÁîüÊ¥ª„ÄÇ‰ªéÊô∫ËÉΩÂÆ∂Â±ÖÂà∞Ëá™Âä®È©æÈ©∂Ê±ΩËΩ¶ÔºåAIÁöÑÂ∫îÁî®ËåÉÂõ¥‰∏çÊñ≠Êâ©Â§ßÔºå‰∏∫‰∫∫‰ª¨Â∏¶Êù•‰∫ÜÊõ¥Â§ö‰æøÂà©ÂíåÂèØËÉΩÊÄß„ÄÇ",
                "ÁªèËøá‰∏ÄÊÆµÊó∂Èó¥ÁöÑË∞ÉÊï¥ÔºåËÇ°Â∏ÇË°®Áé∞ÈÄêÊ∏êÂõûÊöñ„ÄÇÂàÜÊûêÂ∏àËÆ§‰∏∫ÔºåËøôÂèçÊò†‰∫ÜÊäïËµÑËÄÖÂØπÁªèÊµéÂâçÊôØÁöÑ‰ø°ÂøÉÊ≠£Âú®ÈÄêÊ≠•ÊÅ¢Â§çÔºåÊäïËµÑËÄÖÊÉÖÁª™ÊòéÊòæÊîπÂñÑ„ÄÇ",
                "ÂåªÂ≠¶Á†îÁ©∂Ë°®ÊòéÔºåËßÑÂæãÁöÑËøêÂä®‰∏ç‰ªÖÂØπË∫´‰ΩìÂÅ•Â∫∑ÊúâÁõäÔºåÂØπÂ§ßËÑëÂäüËÉΩ‰πüÊúâÁßØÊûÅÂΩ±Âìç„ÄÇËøêÂä®ÂèØ‰ª•ÊîπÂñÑËÆ∞ÂøÜÂäõÔºåÊèêÈ´òÂ≠¶‰π†ÊïàÁéáÔºåÈ¢ÑÈò≤ËÆ§Áü•ÈÄÄÂåñ„ÄÇ",
                "ËøëÊúü‰∏æÂäûÁöÑÂõΩÈôÖ‰ΩìËÇ≤Ëµõ‰∫ãÁ≤æÂΩ©Á∫∑ÂëàÔºåÂêÑÂõΩËøêÂä®ÂëòÂ±ïÁé∞‰∫ÜÈ´òË∂ÖÁöÑÁ´ûÊäÄÊ∞¥Âπ≥„ÄÇËøô‰∫õÊØîËµõ‰∏ç‰ªÖ‰øÉËøõ‰∫ÜÂõΩÈôÖ‰∫§ÊµÅÔºå‰πüÊøÄÂèë‰∫Ü‰∫∫‰ª¨ÂØπ‰ΩìËÇ≤ËøêÂä®ÁöÑÁÉ≠ÊÉÖ„ÄÇ",
                "ÂΩ±ËßÜÂúàËøëÊúüÊ∂åÁé∞Âá∫Â§öÈÉ®‰ºòÁßÄ‰ΩúÂìÅÔºåËøô‰∫õÊñ∞‰ΩúÂú®ÂâßÊÉÖ„ÄÅËßÜËßâÊïàÊûúÂíåË°®ÊºîÁ≠âÊñπÈù¢ÈÉΩË°®Áé∞Âá∫Ëâ≤ÔºåÂºïÂèë‰∫ÜËßÇ‰ºóÁöÑÁÉ≠ÁÉàËÆ®ËÆ∫ÂíåÂπøÊ≥õÂÖ≥Ê≥®„ÄÇ",
                "ÂõΩÈôÖÁªÑÁªáÁßØÊûÅÊé®Âä®ÂÖ®ÁêÉÂêà‰ΩúÔºåÂú®Ë¥∏Êòì„ÄÅÁéØÂ¢É„ÄÅÂÆâÂÖ®Á≠âÈ¢ÜÂüüÂèñÂæó‰∫ÜÈáçË¶ÅËøõÂ±ï„ÄÇËøô‰∫õÂêà‰ΩúÊúâÂä©‰∫éÁª¥Êä§‰∏ñÁïåÂíåÂπ≥Ôºå‰øÉËøõÂÖ±ÂêåÂèëÂ±ï„ÄÇ",
                "ÂêÑÂõΩÊîøÂ∫úÂíå‰ºÅ‰∏öÁ∫∑Á∫∑Êé®Âá∫ÁéØ‰øùÊñ∞‰∏æÊé™ÔºåÁªøËâ≤ÁßëÊäÄÁöÑÂèëÂ±ï‰∏∫ÂèØÊåÅÁª≠ÂèëÂ±ïÊèê‰æõ‰∫ÜÊñ∞ÁöÑËß£ÂÜ≥ÊñπÊ°à„ÄÇËøô‰∫õÂä™ÂäõÂ∞ÜÊúâÂä©‰∫é‰øùÊä§Êàë‰ª¨ÁöÑÂú∞ÁêÉÂÆ∂Âõ≠„ÄÇ",
                "ÊïôËÇ≤È¢ÜÂüüÊ≠£Âú®ÁªèÂéÜÊï∞Â≠óÂåñÂèòÈù©ÔºåÂêÑÁßçÂú®Á∫øÂ≠¶‰π†Âπ≥Âè∞ÂíåÊï∞Â≠óÂåñÊïôÂ≠¶Â∑•ÂÖ∑Êó•ÁõäÊôÆÂèä„ÄÇËøô‰∫õÊäÄÊúØÂàõÊñ∞‰∏∫ÊïôËÇ≤ÂÖ¨Âπ≥ÂíåË¥®ÈáèÊèêÂçáÂàõÈÄ†‰∫ÜÊñ∞ÁöÑÊú∫‰ºö„ÄÇ",
                "ÂåªÁñóÈ¢ÜÂüüÂèñÂæóÈáçÂ§ßÁ™ÅÁ†¥ÔºåÊñ∞ÂûãÊ≤ªÁñóÊñπÊ≥ï‰∏∫ËÆ∏Â§öÁñæÁóÖÁöÑÊ≤ªÁñóÂ∏¶Êù•‰∫ÜÂ∏åÊúõ„ÄÇËøô‰∫õËøõÂ±ïÂ∞ÜÊîπÂñÑÊÇ£ËÄÖÁöÑÁîüÊ¥ªË¥®ÈáèÔºåÂª∂Èïø‰∫∫Á±ªÂØøÂëΩ„ÄÇ",
                "Âàõ‰∏öÂÖ¨Âè∏ÈÄöËøáÂàõÊñ∞È©±Âä®ÔºåÂú®ÂêÑ‰∏™Ë°å‰∏ö‰∏≠ÂèëÊå•ÁùÄÈáçË¶Å‰ΩúÁî®„ÄÇËøô‰∫õÊñ∞ÂÖ¥‰ºÅ‰∏ö‰∏ç‰ªÖÂàõÈÄ†‰∫ÜÂ∞±‰∏öÊú∫‰ºöÔºå‰πü‰∏∫ÁªèÊµéÂèëÂ±ïÊ≥®ÂÖ•‰∫ÜÊñ∞Ê¥ªÂäõ„ÄÇ"
            ];
            
            const newsList = [];
            for (let i = 0; i < 6; i++) {
                const source = newsSources[Math.floor(Math.random() * newsSources.length)];
                const titleIndex = Math.floor(Math.random() * newsTitles.length);
                
                newsList.push({
                    id: i + 1,
                    title: newsTitles[titleIndex],
                    summary: newsContent[titleIndex].substring(0, 100) + "...",
                    content: newsContent[titleIndex],
                    source: source.name,
                    category: source.category,
                    time: new Date().toLocaleString('zh-CN'),
                    image: `https://picsum.photos/300/200?random=${i + 1}`,
                    readTime: Math.floor(Math.random() * 5) + 2 + "ÂàÜÈíü"
                });
            }
            return newsList;
        }
        
        // ÊòæÁ§∫Êñ∞ÈóªÂàóË°®
        function showNewsList() {
            try {
                // ÊòæÁ§∫ÈÅÆÁΩ©Â±ÇÂíåÊñ∞ÈóªÂç°Áâá
                document.getElementById('news-overlay').style.display = 'block';
                document.getElementById('popup-news-card').style.display = 'block';
                
                // ÁîüÊàêÊñ∞ÈóªÊï∞ÊçÆ
                newsList = generateMockNews();
                currentNewsIndex = 0;
                
                // ÊòæÁ§∫Á¨¨‰∏ÄÊù°Êñ∞Èóª
                displayCurrentNews();
                
                // ÈáçÁΩÆËÆ°Êó∂Âô®
                resetNewsTimer();
                
                // Ê∑ªÂä†ÊéßÂà∂ÊåâÈíÆ‰∫ã‰ª∂
                addNewsControlEvents();
                
            } catch (error) {
                console.error('ÊòæÁ§∫Êñ∞ÈóªÂàóË°®Â§±Ë¥•:', error);
                alert('Ëé∑ÂèñÊñ∞ÈóªÂ§±Ë¥•ÔºåËØ∑Á®çÂêéÈáçËØï');
            }
        }
        
        // ÊòæÁ§∫ÂΩìÂâçÊñ∞Èóª
        function displayCurrentNews() {
            const newsListContainer = document.getElementById('news-list');
            
            if (currentNewsIndex >= newsList.length) {
                currentNewsIndex = 0; // Âæ™ÁéØÊí≠Êîæ
            }
            
            const news = newsList[currentNewsIndex];
            
            newsListContainer.innerHTML = `
                <div class="news-item active" data-news-id="${news.id}">
                    <div class="news-image">
                        <img src="${news.image}" alt="${news.title}" />
                    </div>
                    <div class="news-content">
                        <div class="news-title">${news.title}</div>
                        <div class="news-meta">
                            <span class="news-source">üì∞ ${news.source}</span>
                            <span class="news-category">üè∑Ô∏è ${news.category}</span>
                            <span class="news-time">üïí ${news.time}</span>
                            <span class="news-readtime">üìñ ${news.readTime}</span>
                        </div>
                        <div class="news-summary">${news.summary}</div>
                        <div class="news-full-content" style="display: none;">${news.content}</div>
                        <div class="news-buttons">
                            <button class="news-detail-btn" onclick="toggleNewsDetail(${news.id})">
                                üìñ Êü•ÁúãËØ¶ÊÉÖ
                            </button>
                            <button class="news-share-btn" onclick="shareNews(${news.id})">
                                üì§ ÂàÜ‰∫´
                            </button>
                        </div>
                    </div>
                </div>
            `;
        }
        
        // ÂàáÊç¢Êñ∞ÈóªËØ¶ÊÉÖÊòæÁ§∫
        function toggleNewsDetail(newsId) {
            const newsItem = document.querySelector(`[data-news-id="${newsId}"]`);
            const summary = newsItem.querySelector('.news-summary');
            const fullContent = newsItem.querySelector('.news-full-content');
            const detailBtn = newsItem.querySelector('.news-detail-btn');
            
            if (fullContent.style.display === 'none') {
                summary.style.display = 'none';
                fullContent.style.display = 'block';
                detailBtn.textContent = 'üìú Êî∂Ëµ∑ËØ¶ÊÉÖ';
            } else {
                summary.style.display = 'block';
                fullContent.style.display = 'none';
                detailBtn.textContent = 'üìñ Êü•ÁúãËØ¶ÊÉÖ';
            }
        }
        
        // ÂàÜ‰∫´Êñ∞Èóª
        function shareNews(newsId) {
            const news = newsList.find(n => n.id === newsId);
            if (news && navigator.share) {
                navigator.share({
                    title: news.title,
                    text: news.summary,
                    url: window.location.href
                });
            } else {
                // Â§çÂà∂Âà∞Ââ™Ë¥¥Êùø
                const shareText = `${news.title}\n\n${news.summary}\n\nÊù•Ê∫êÔºö${news.source}\nÊó∂Èó¥Ôºö${news.time}`;
                navigator.clipboard.writeText(shareText).then(() => {
                    alert('Êñ∞ÈóªÂÜÖÂÆπÂ∑≤Â§çÂà∂Âà∞Ââ™Ë¥¥ÊùøÔºÅ');
                }).catch(() => {
                    alert('ÂàÜ‰∫´ÂäüËÉΩÊöÇ‰∏çÂèØÁî®');
                });
            }
        }
        
        // Ê∑ªÂä†Êñ∞ÈóªÊéßÂà∂‰∫ã‰ª∂
        function addNewsControlEvents() {
            // ÂÖ≥Èó≠ÊåâÈíÆ
            document.getElementById('close-news-btn').onclick = closeNews;
            
            // Âà∑Êñ∞ÊåâÈíÆ
            document.getElementById('refresh-news-btn').onclick = refreshNews;
            
            // ÈöèÊú∫Êñ∞ÈóªÊåâÈíÆ
            document.getElementById('random-news-btn').onclick = getRandomNews;
            
            // ÈÅÆÁΩ©Â±ÇÁÇπÂáªÂÖ≥Èó≠
            document.getElementById('news-overlay').onclick = closeNews;
            
            // ÈîÆÁõò‰∫ã‰ª∂
            document.addEventListener('keydown', handleNewsKeydown);
        }
        
        // Â§ÑÁêÜÊñ∞ÈóªÁõ∏ÂÖ≥ÈîÆÁõò‰∫ã‰ª∂
        function handleNewsKeydown(e) {
            if (document.getElementById('popup-news-card').style.display === 'block') {
                switch(e.key) {
                    case 'Escape':
                        closeNews();
                        break;
                    case 'ArrowLeft':
                        previousNews();
                        break;
                    case 'ArrowRight':
                        nextNews();
                        break;
                    case ' ':
                        e.preventDefault();
                        toggleNewsPlayback();
                        break;
                }
            }
        }
        
        // ÂÖ≥Èó≠Êñ∞ÈóªÂç°Áâá
        function closeNews() {
            document.getElementById('news-overlay').style.display = 'none';
            document.getElementById('popup-news-card').style.display = 'none';
            stopNewsTimer();
            newsPlaying = false;
            document.removeEventListener('keydown', handleNewsKeydown);
        }
        
        // Âà∑Êñ∞Êñ∞Èóª
        function refreshNews() {
            newsList = generateMockNews();
            currentNewsIndex = 0;
            displayCurrentNews();
            resetNewsTimer();
        }
        
        // Ëé∑ÂèñÈöèÊú∫Êñ∞Èóª
        function getRandomNews() {
            currentNewsIndex = Math.floor(Math.random() * newsList.length);
            displayCurrentNews();
            resetNewsTimer();
        }
        
        // ‰∏ä‰∏ÄÊù°Êñ∞Èóª
        function previousNews() {
            currentNewsIndex = (currentNewsIndex - 1 + newsList.length) % newsList.length;
            displayCurrentNews();
            resetNewsTimer();
        }
        
        // ‰∏ã‰∏ÄÊù°Êñ∞Èóª
        function nextNews() {
            currentNewsIndex = (currentNewsIndex + 1) % newsList.length;
            displayCurrentNews();
            resetNewsTimer();
        }
        
        // ÈáçÁΩÆÊñ∞ÈóªËÆ°Êó∂Âô®
        function resetNewsTimer() {
            stopNewsTimer();
            newsStartTime = Date.now();
            newsPlaying = true;
            updateNewsTimer();
        }
        
        // ÂÅúÊ≠¢Êñ∞ÈóªËÆ°Êó∂Âô®
        function stopNewsTimer() {
            if (newsTimer) {
                clearInterval(newsTimer);
                newsTimer = null;
            }
        }
        
        // Êõ¥Êñ∞Êñ∞ÈóªËÆ°Êó∂Âô®ÊòæÁ§∫
        function updateNewsTimer() {
            const elapsed = Math.floor((Date.now() - newsStartTime) / 1000);
            const remaining = Math.max(0, 60 - elapsed);
            
            document.getElementById('news-timer').textContent = remaining + 's';
            
            if (remaining <= 0) {
                nextNews(); // Ëá™Âä®ÂàáÊç¢Âà∞‰∏ã‰∏ÄÊù°Êñ∞Èóª
            } else {
                newsTimer = setTimeout(updateNewsTimer, 1000);
            }
        }
        
        // ÂàáÊç¢Êñ∞ÈóªÊí≠ÊîæÁä∂ÊÄÅ
        function toggleNewsPlayback() {
            if (newsPlaying) {
                stopNewsTimer();
                newsPlaying = false;
                document.getElementById('news-timer').textContent = '‚è∏Ô∏è';
            } else {
                resetNewsTimer();
                newsPlaying = true;
            }
        }
        
    </script>
</body>
</html>